{"title":"Calibrate boilprep to Qiagen DNeasy","markdown":{"yaml":{"title":"Calibrate boilprep to Qiagen DNeasy","author":"Shane Hogle","date":"today","link-citations":true},"headingText":"Introduction","containsRefs":false,"markdown":"\n\n\nWe will use the [metacal package](https://mikemc.github.io/metacal/) for estimating bias and performing calibration in the special case where the bias of all the taxa of interest can be directly measured from the control sample. Since samples extracted by Qiagen and by boil are exactly the same we can estimate scaling factors to produce corrected relative abundance for other samples.\n\nPublication: [Consistent and correctable bias in metagenomic sequencing experiments](https://elifesciences.org/articles/46923)\n\n# Setup\n\n## Libraries\n\n```{r}\n#| output: false\nlibrary(here)\nlibrary(tidyverse)\nlibrary(metacal)\nlibrary(withr)\nlibrary(scales)\nsource(here::here(\"R\", \"utils_generic.R\"))\n```\n\n## Global variables\n\n```{r}\ndata_raw <- here::here(\"_data_raw\", \"20240711_BTK_illumina_v3\")\ndata <- here::here(\"data\", \"20240711_BTK_illumina_v3\")\n\n# make processed data directory if it doesn't exist\nfs::dir_create(data)\n```\n\n# Read data\n\n```{r}\n#| output: false\npos_ctrl <- read_tsv(here::here(data, \"pos_neg_ctrl_counts.tsv\"))\nsamp_pairs <- read_tsv(here::here(data, \"pairs_counts.tsv\"))\nsamp_trios <- read_tsv(here::here(data, \"trios_counts.tsv\"))\n\n# metadata\nmddf <- readr::read_tsv(here::here(data_raw, \"20240711_BTK_illumina_v3_metadata.tsv\"))\nspdf <- readr::read_tsv(here::here(data_raw, \"sample_compositions.tsv\"))\n```\n\n# Formatting\n\n## Format positive control samples\n\n```{r}\npos_ctrl <- left_join(pos_ctrl, spdf) %>% \n  filter(str_detect(community_type, \"^pos\")) %>%\n  # remove noise from species that aren't really there\n  filter(!is.na(evo_hist)) %>% \n  group_by(sample) %>% \n  mutate(f_qg = count_correct/sum(count_correct)) %>% \n  dplyr::select(sample, strainID, community_id, count_correct, f_qg) %>% \n  ungroup()\n```\n\n## Plot masterplate Qiagen and boil-prep side by side\n\n::: {#fig-01}\n```{r}\n#| fig.width: 8\n#| fig.height: 5\nleft_join(samp_trios, mddf,\n          by = join_by(sample, replicate, strep_conc, transfers, n_species, community_type, plate_well)) %>% \n  filter(community_type == \"masterplate\") %>% \n  right_join(pos_ctrl, by = join_by(strainID, community_id)) %>% \n  dplyr::select(community_id, strainID, f, f_qg) %>% \n  pivot_longer(c(f, f_qg)) %>% \n  ggplot() +\n    geom_bar(aes(y = value, x=interaction(name, community_id), fill = strainID), \n             color=\"black\",\n             linewidth=0.25, stat=\"identity\") +\n    scale_y_continuous(limits = c(0,1), expand = c(0, 0), labels = percent) +\n    scale_x_discrete(guide = guide_axis(angle = 90)) +\n    labs(x=\"\", y=\"% abundance\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\") +\n  scale_fill_manual(values = hambi_colors)\n```\nBar plot of masterplate samples extracted by the boilprep method (f) or the Qiagen DNeasy kit (qg). The community trios are appended to the extraction method on the x axs\n:::\n\n## Matrix of observed counts\n\n```{r}\nsamp_trios_counts <- left_join(samp_trios, mddf) %>% \n  filter(community_type == \"masterplate\") %>% \n  filter(community_id %in% pull(pos_ctrl, community_id)) %>% \n  dplyr::select(community_id, strainID, count_correct) %>% \n  pivot_wider(names_from=\"strainID\", values_from=\"count_correct\") %>% \n  column_to_rownames(var=\"community_id\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>% \n  as.matrix()\n```\n\n## Make a matrix of true proportions\n\n```{r}\npos_ctrl_proportions <- pos_ctrl %>% \n  dplyr::select(community_id, strainID, f_qg) %>%\n  pivot_wider(names_from=\"strainID\", values_from=\"f_qg\") %>% \n  column_to_rownames(var=\"community_id\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>% \n  as.matrix()\n```\n\n# Metacal procedure\n\n## Estimate bias\n\n```{r}\nset.seed(12378)\nmc_fit_trios <- metacal::estimate_bias(samp_trios_counts, pos_ctrl_proportions, 1, boot=TRUE)\nmc_fit_trios_summary <- summary(mc_fit_trios)\nmc_fit_trios_summary_coef <-mc_fit_trios_summary[['coefficients']]\n```\n\n### Plot bias estimation\n\n::: {#fig-02}\n```{r}\nmc_fit_trios_summary_coef %>% \n  mutate(taxon = fct_reorder(taxon, estimate)) |> \n  ggplot(aes(taxon, estimate, \n             ymin = estimate / gm_se^2, ymax = estimate * gm_se^2)) +\n  geom_hline(yintercept = 1, color = \"grey\") +\n  geom_pointrange(aes(color = taxon)) +\n  scale_color_manual(values = hambi_colors) +\n  labs(x = \"\", y = \"Bias estimate\", color = \"\") +\n  coord_flip() + \n  theme_bw() +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank())\n```\nBias estimates for each species from the metacal procedure.\n:::\n\n### Plot metacal model fit\n\n```{r}\na <- as.data.frame(fitted(mc_fit_trios)) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample) %>% \n  mutate(type=\"Fitted\")\n\nb <- as.data.frame(pos_ctrl_proportions) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample) %>% \n  mutate(type=\"Actual\")\n\nc <- as.data.frame(samp_trios_counts/rowSums(samp_trios_counts)) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample,  values_to=\"observed\")\n```\n\n\n::: {#fig-03}\n```{r}\nbind_rows(a,b) %>% \n  left_join(c) %>% \n  ggplot(aes(x=observed, y=value, color = name)) +\n  geom_abline(linetype = \"dashed\") +\n  geom_point() +\n  scale_color_manual(values = hambi_colors) +\n  labs(x = \"Species proportion in boil-prepped samples\", y = \"Species proportion in Qiagen-prepped samples\", color = \"\") +\n  facet_grid(~type) + \n  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) + \n  theme_bw() +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank())\n```\nPorportion of each species from boil-prepped samples (x-axis) and from the Qiagen DNeasy extracted samples (y-axis) colored by species identity. The left panel shows the relationship between the two extraction procedures before correction with metacal. The right panel shows the relationship after correction. The dashed line is 1:1. \n:::\n\n\n## Calibrate\n\nMake a matrix of observed counts\n```{r}\ntrios_2_cal <- left_join(samp_trios, mddf) %>% \n  dplyr::select(sample, strainID, count_correct) %>% \n  pivot_wider(names_from=\"strainID\", values_from=\"count_correct\") %>% \n  column_to_rownames(var=\"sample\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>%\n  as.matrix()\n\npairs_2_cal <- left_join(samp_pairs, mddf) %>% \n  dplyr::select(sample, strainID, count_correct) %>% \n  pivot_wider(names_from=\"strainID\", values_from=\"count_correct\") %>% \n  column_to_rownames(var=\"sample\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>%\n  as.matrix()\n```\n\n## Run the calibrate function\n\n```{r}\nset.seed(435761)\n\npairs_calibrated <- metacal::calibrate(pairs_2_cal, coef(mc_fit_trios), margin=1)\ntrios_calibrated <- metacal::calibrate(trios_2_cal, coef(mc_fit_trios), margin=1)\n```\n\n\n```{r}\npairs_calibrated_l <- data.frame(pairs_calibrated) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample, names_to = \"strainID\", values_to = \"f_metacal\") %>% \n  filter(f_metacal > 0)\n\ntrios_calibrated_l <- data.frame(trios_calibrated) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample, names_to = \"strainID\", values_to = \"f_metacal\") %>% \n  filter(f_metacal > 0)\n```\n\n# Export\n\nSave metacal esimates for later use\n```{r}\nwrite_tsv(pairs_calibrated_l, here::here(data, \"pairs_metacal.tsv\"))\nwrite_tsv(trios_calibrated_l, here::here(data, \"trios_metacal.tsv\"))\n```\n","srcMarkdownNoYaml":"\n\n# Introduction\n\nWe will use the [metacal package](https://mikemc.github.io/metacal/) for estimating bias and performing calibration in the special case where the bias of all the taxa of interest can be directly measured from the control sample. Since samples extracted by Qiagen and by boil are exactly the same we can estimate scaling factors to produce corrected relative abundance for other samples.\n\nPublication: [Consistent and correctable bias in metagenomic sequencing experiments](https://elifesciences.org/articles/46923)\n\n# Setup\n\n## Libraries\n\n```{r}\n#| output: false\nlibrary(here)\nlibrary(tidyverse)\nlibrary(metacal)\nlibrary(withr)\nlibrary(scales)\nsource(here::here(\"R\", \"utils_generic.R\"))\n```\n\n## Global variables\n\n```{r}\ndata_raw <- here::here(\"_data_raw\", \"20240711_BTK_illumina_v3\")\ndata <- here::here(\"data\", \"20240711_BTK_illumina_v3\")\n\n# make processed data directory if it doesn't exist\nfs::dir_create(data)\n```\n\n# Read data\n\n```{r}\n#| output: false\npos_ctrl <- read_tsv(here::here(data, \"pos_neg_ctrl_counts.tsv\"))\nsamp_pairs <- read_tsv(here::here(data, \"pairs_counts.tsv\"))\nsamp_trios <- read_tsv(here::here(data, \"trios_counts.tsv\"))\n\n# metadata\nmddf <- readr::read_tsv(here::here(data_raw, \"20240711_BTK_illumina_v3_metadata.tsv\"))\nspdf <- readr::read_tsv(here::here(data_raw, \"sample_compositions.tsv\"))\n```\n\n# Formatting\n\n## Format positive control samples\n\n```{r}\npos_ctrl <- left_join(pos_ctrl, spdf) %>% \n  filter(str_detect(community_type, \"^pos\")) %>%\n  # remove noise from species that aren't really there\n  filter(!is.na(evo_hist)) %>% \n  group_by(sample) %>% \n  mutate(f_qg = count_correct/sum(count_correct)) %>% \n  dplyr::select(sample, strainID, community_id, count_correct, f_qg) %>% \n  ungroup()\n```\n\n## Plot masterplate Qiagen and boil-prep side by side\n\n::: {#fig-01}\n```{r}\n#| fig.width: 8\n#| fig.height: 5\nleft_join(samp_trios, mddf,\n          by = join_by(sample, replicate, strep_conc, transfers, n_species, community_type, plate_well)) %>% \n  filter(community_type == \"masterplate\") %>% \n  right_join(pos_ctrl, by = join_by(strainID, community_id)) %>% \n  dplyr::select(community_id, strainID, f, f_qg) %>% \n  pivot_longer(c(f, f_qg)) %>% \n  ggplot() +\n    geom_bar(aes(y = value, x=interaction(name, community_id), fill = strainID), \n             color=\"black\",\n             linewidth=0.25, stat=\"identity\") +\n    scale_y_continuous(limits = c(0,1), expand = c(0, 0), labels = percent) +\n    scale_x_discrete(guide = guide_axis(angle = 90)) +\n    labs(x=\"\", y=\"% abundance\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\") +\n  scale_fill_manual(values = hambi_colors)\n```\nBar plot of masterplate samples extracted by the boilprep method (f) or the Qiagen DNeasy kit (qg). The community trios are appended to the extraction method on the x axs\n:::\n\n## Matrix of observed counts\n\n```{r}\nsamp_trios_counts <- left_join(samp_trios, mddf) %>% \n  filter(community_type == \"masterplate\") %>% \n  filter(community_id %in% pull(pos_ctrl, community_id)) %>% \n  dplyr::select(community_id, strainID, count_correct) %>% \n  pivot_wider(names_from=\"strainID\", values_from=\"count_correct\") %>% \n  column_to_rownames(var=\"community_id\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>% \n  as.matrix()\n```\n\n## Make a matrix of true proportions\n\n```{r}\npos_ctrl_proportions <- pos_ctrl %>% \n  dplyr::select(community_id, strainID, f_qg) %>%\n  pivot_wider(names_from=\"strainID\", values_from=\"f_qg\") %>% \n  column_to_rownames(var=\"community_id\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>% \n  as.matrix()\n```\n\n# Metacal procedure\n\n## Estimate bias\n\n```{r}\nset.seed(12378)\nmc_fit_trios <- metacal::estimate_bias(samp_trios_counts, pos_ctrl_proportions, 1, boot=TRUE)\nmc_fit_trios_summary <- summary(mc_fit_trios)\nmc_fit_trios_summary_coef <-mc_fit_trios_summary[['coefficients']]\n```\n\n### Plot bias estimation\n\n::: {#fig-02}\n```{r}\nmc_fit_trios_summary_coef %>% \n  mutate(taxon = fct_reorder(taxon, estimate)) |> \n  ggplot(aes(taxon, estimate, \n             ymin = estimate / gm_se^2, ymax = estimate * gm_se^2)) +\n  geom_hline(yintercept = 1, color = \"grey\") +\n  geom_pointrange(aes(color = taxon)) +\n  scale_color_manual(values = hambi_colors) +\n  labs(x = \"\", y = \"Bias estimate\", color = \"\") +\n  coord_flip() + \n  theme_bw() +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank())\n```\nBias estimates for each species from the metacal procedure.\n:::\n\n### Plot metacal model fit\n\n```{r}\na <- as.data.frame(fitted(mc_fit_trios)) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample) %>% \n  mutate(type=\"Fitted\")\n\nb <- as.data.frame(pos_ctrl_proportions) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample) %>% \n  mutate(type=\"Actual\")\n\nc <- as.data.frame(samp_trios_counts/rowSums(samp_trios_counts)) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample,  values_to=\"observed\")\n```\n\n\n::: {#fig-03}\n```{r}\nbind_rows(a,b) %>% \n  left_join(c) %>% \n  ggplot(aes(x=observed, y=value, color = name)) +\n  geom_abline(linetype = \"dashed\") +\n  geom_point() +\n  scale_color_manual(values = hambi_colors) +\n  labs(x = \"Species proportion in boil-prepped samples\", y = \"Species proportion in Qiagen-prepped samples\", color = \"\") +\n  facet_grid(~type) + \n  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) + \n  theme_bw() +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank())\n```\nPorportion of each species from boil-prepped samples (x-axis) and from the Qiagen DNeasy extracted samples (y-axis) colored by species identity. The left panel shows the relationship between the two extraction procedures before correction with metacal. The right panel shows the relationship after correction. The dashed line is 1:1. \n:::\n\n\n## Calibrate\n\nMake a matrix of observed counts\n```{r}\ntrios_2_cal <- left_join(samp_trios, mddf) %>% \n  dplyr::select(sample, strainID, count_correct) %>% \n  pivot_wider(names_from=\"strainID\", values_from=\"count_correct\") %>% \n  column_to_rownames(var=\"sample\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>%\n  as.matrix()\n\npairs_2_cal <- left_join(samp_pairs, mddf) %>% \n  dplyr::select(sample, strainID, count_correct) %>% \n  pivot_wider(names_from=\"strainID\", values_from=\"count_correct\") %>% \n  column_to_rownames(var=\"sample\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>%\n  as.matrix()\n```\n\n## Run the calibrate function\n\n```{r}\nset.seed(435761)\n\npairs_calibrated <- metacal::calibrate(pairs_2_cal, coef(mc_fit_trios), margin=1)\ntrios_calibrated <- metacal::calibrate(trios_2_cal, coef(mc_fit_trios), margin=1)\n```\n\n\n```{r}\npairs_calibrated_l <- data.frame(pairs_calibrated) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample, names_to = \"strainID\", values_to = \"f_metacal\") %>% \n  filter(f_metacal > 0)\n\ntrios_calibrated_l <- data.frame(trios_calibrated) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample, names_to = \"strainID\", values_to = \"f_metacal\") %>% \n  filter(f_metacal > 0)\n```\n\n# Export\n\nSave metacal esimates for later use\n```{r}\nwrite_tsv(pairs_calibrated_l, here::here(data, \"pairs_metacal.tsv\"))\nwrite_tsv(trios_calibrated_l, here::here(data, \"trios_metacal.tsv\"))\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":8,"fig-height":6,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"number-sections":true,"output-file":"02_correct_boil_to_qiagen.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.553","editor":"source","theme":["cosmo","../../../mystyle.scss"],"tidy":true,"title":"Calibrate boilprep to Qiagen DNeasy","author":"Shane Hogle","date":"today","link-citations":true},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}