{"title":"Formatting Rbec output","markdown":{"yaml":{"title":"Formatting Rbec output","author":"Shane Hogle","date":"today","link-citations":true},"headingText":"Introduction","containsRefs":false,"markdown":"\n\n\nContains results from pairs of all streptomycin concentrations and trios for 0 streptomycin from Milla's bottom up community assembly experiment\n\n# Setup\n\n## Libraries\n\n```{r}\n#| output: false\nlibrary(tidyverse)\nlibrary(here)\nlibrary(fs)\nlibrary(archive)\nlibrary(scales)\nsource(here::here(\"R\", \"utils_generic.R\"))\n```\n\n## Global variables\n\n```{r}\ndata_raw <- here::here(\"_data_raw\", \"20240711_BTK_illumina_v3\")\ndata <- here::here(\"data\", \"20240711_BTK_illumina_v3\")\namplicontar <- here::here(data_raw, \"rbec_output.tar.gz\")\n\n# make processed data directory if it doesn't exist\nfs::dir_create(data)\n\n# create temporary location to decompress\ntmpdir <- fs::file_temp()\n```\n\n## Data\n\nNOTE! We have commented out the species not included in this experiment  \n```{r}\ntax_locus_copynum <- tibble::tribble(\n     ~strainID, ~rRNA16S_cn, ~rRNA16S_locus,             ~genus,        ~species,\n  \"HAMBI_0006\",          7L,  \"H0006_04757\",      \"Pseudomonas\",        \"putida\",\n  \"HAMBI_0097\",          7L,  \"H0097_00044\",    \"Acinetobacter\",     \"johnsonii\",\n  \"HAMBI_0097\",          7L,  \"H0097_02759\",    \"Acinetobacter\",     \"johnsonii\",\n  \"HAMBI_0097\",          7L,  \"H0097_01762\",    \"Acinetobacter\",     \"johnsonii\",\n  \"HAMBI_0105\",          4L,  \"H0105_02306\",    \"Agrobacterium\",   \"tumefaciens\",\n  \"HAMBI_0262\",          3L,  \"H0262_00030\",    \"Brevundimonas\",       \"bullata\",\n  \"HAMBI_0403\",          9L,  \"H0403_00517\",        \"Comamonas\",  \"testosteroni\",\n  \"HAMBI_0403\",          9L,  \"H0403_00522\",        \"Comamonas\",  \"testosteroni\",\n  \"HAMBI_1279\",          7L,  \"H1279_03627\",           \"Hafnia\",         \"alvei\",\n  \"HAMBI_1279\",          7L,  \"H1279_00125\",           \"Hafnia\",         \"alvei\",\n  \"HAMBI_1279\",          7L,  \"H1279_03957\",           \"Hafnia\",         \"alvei\",\n  \"HAMBI_1287\",          7L,  \"H1287_03997\",      \"Citrobacter\",        \"koseri\",\n  \"HAMBI_1287\",          7L,  \"H1287_03402\",      \"Citrobacter\",        \"koseri\",\n  \"HAMBI_1292\",          7L,  \"H1292_03239\",       \"Morganella\",      \"morganii\",\n  \"HAMBI_1299\",          8L,  \"H1299_04293\",         \"Kluyvera\",    \"intermedia\",\n  \"HAMBI_1299\",          8L,  \"H1299_01283\",         \"Kluyvera\",    \"intermedia\",\n  \"HAMBI_1299\",          8L,  \"H1279_03957\",         \"Kluyvera\",    \"intermedia\",\n  \"HAMBI_1842\",          4L,  \"H1842_01650\",      \"Sphingobium\",    \"yanoikuyae\",\n  \"HAMBI_1896\",          4L,  \"H1896_00963\", \"Sphingobacterium\",  \"spiritivorum\",\n  \"HAMBI_1972\",         10L,  \"H1972_00343\",        \"Aeromonas\",        \"caviae\",\n  \"HAMBI_1972\",         10L,  \"H1972_03531\",        \"Aeromonas\",        \"caviae\",\n  \"HAMBI_1977\",          5L,  \"H1977_00118\",      \"Pseudomonas\",  \"chlororaphis\",\n  \"HAMBI_1988\",          5L,  \"H1988_05160\",     \"Chitinophaga\",        \"sancti\",\n  \"HAMBI_1988\",          5L,  \"H1988_05152\",     \"Chitinophaga\",        \"sancti\",\n  \"HAMBI_1988\",          5L,  \"H1988_05165\",     \"Chitinophaga\",        \"sancti\",\n  \"HAMBI_2159\",          4L,  \"H2159_01406\",        \"Trinickia\",   \"caryophylli\",\n  \"HAMBI_2159\",          4L,  \"H2159_05851\",        \"Trinickia\",   \"caryophylli\",\n  \"HAMBI_2160\",          3L,  \"H2160_00530\",       \"Bordetella\",         \"avium\",\n  \"HAMBI_2164\",          5L,  \"H2164_03337\",      \"Cupriavidus\",    \"oxalaticus\",\n  \"HAMBI_2443\",          3L,  \"H2443_00128\",       \"Paracoccus\", \"denitrificans\",\n  \"HAMBI_2494\",          4L,  \"H2494_03389\", \"Paraburkholderia\",   \"kururiensis\",\n  \"HAMBI_2659\",          4L,  \"H2659_00367\", \"Stenotrophomonas\",   \"maltophilia\",\n  \"HAMBI_2792\",          4L,  \"H2792_00549\",        \"Moraxella\",         \"canis\",\n  \"HAMBI_3031\",          2L,  \"H3031_00830\",         \"Niabella\",  \"yanshanensis\",\n  \"HAMBI_3237\",          6L,  \"H3237_00875\",       \"Microvirga\",   \"lotononidis\",\n  \"HAMBI_1923\",          6L,  \"H1923_00876\",   \"Flavobacterium\",      \"odoratum\"\n  )\n```\n\n## Functions\n```{r}\n# this function \nnormalize_by_copy <- function(.data, tlc = tax_locus_copynum){\n  .data %>% \n    # join with the copy number data frame. We join by the locus tag so this will add H1279_03957 to HAMBI_1299\n    dplyr::left_join(tlc, by = join_by(rRNA16S_locus)) %>%\n    # get total number of mapping reads per species. This aggregates all the difference ASVs per species\n    dplyr::summarize(count = sum(count), .by = c(sample, strainID, rRNA16S_cn)) %>% \n    # group by sample\n    dplyr::group_by(sample) %>% \n    # calculate a corrected count which is simply the count divided by copy num for each species\n    # dividide by the sum of count divided by copy num for whole sample multiplied by the total\n    # number of mapped reads per sample\n    dplyr::mutate(count_correct = round(sum(count)*(count/rRNA16S_cn)/sum(count/rRNA16S_cn))) %>%  \n    dplyr::ungroup() %>% \n    dplyr::select(sample, strainID, count, count_correct)\n  }\n\n# this function replaces missing species counts with zero\ncompletecombos <- function(.data, tlc = tax_locus_copynum, countname = count, remove1923 = TRUE){\n \n  # get unique strainIDs\n  strainID <- unique(tlc$strainID)\n  # table for assigning genus and species names. Doesn't matter if 1923 is there or not\n  # because it is filter joined later\n  tax <- dplyr::distinct(dplyr::select(tlc, strainID, genus, species))\n  if (remove1923) {\n    # get unique strainIDs but exclude 1923 if remove1923 is true\n    strainID <- strainID[strainID != \"HAMBI_1923\"]\n  }\n  \n  dplyr::bind_rows(tibble::tibble(strainID = strainID, sample = \"dummy\"), .data) %>% \n    dplyr::mutate( \"{{ countname }}\" := dplyr::if_else(sample == \"dummy\", 1, {{ countname }})) %>% \n    tidyr::complete(sample, strainID) %>% \n    dplyr::filter(sample != \"dummy\") %>% \n    dplyr::mutate( \"{{ countname }}\" := dplyr::if_else(is.na({{ countname }}), 0, {{ countname }})) %>% \n    tidyr::replace_na(list(count_correct = 0)) %>% \n    dplyr::left_join(dplyr::distinct(dplyr::select(tlc, strainID, genus, species))) %>% \n    dplyr::relocate(genus, species, .after = strainID)\n}\n```\n\n# Read metadata\n\n```{r}\nmddf <- readr::read_tsv(here::here(data_raw, \"20240711_BTK_illumina_v3_metadata.tsv\"))\nspdf <- readr::read_tsv(here::here(data_raw, \"sample_compositions.tsv\"))\n```\n\n# Read Rbec raw counts tables \n\n## Untar Rbec output tarball\n\n```{r}\narchive::archive_extract(\n  amplicontar,\n  dir = tmpdir,\n  files = NULL,\n  options = character(),\n  strip_components = 0L\n)\n```\n\n## Setup directory structure\n\n```{r}\ntabdir <- here::here(tmpdir, \"rbec_output\")\nsamppaths <- fs::dir_ls(tabdir)\nsampnames <- path_split(samppaths) %>% \n  map_chr(dplyr::last)\n```\n\n## Read\n\n```{r}\nstraintabs <- paste0(samppaths, \"/strain_table.txt\") %>% \n  set_names(sampnames) %>% \n  map_df(\n  read_tsv,\n  skip = 1,\n  col_names = c(\"rRNA16S_locus\",\"count\"),\n  show_col_types = FALSE, \n  .id = \"sample\") %>% \n  # naming scheme inconsistent for one sample\n  mutate(sample = if_else(sample == \"P2_s_0\", \"P02_s_0\", sample))\n```\n\n# Format\n\nNormalize counts by 16S copy number\n```{r}\nstraintabs_norm <- normalize_by_copy(straintabs)\n```\n\n```{r}\nfinaltable <- left_join(straintabs_norm, mddf) %>% \n  left_join(spdf)\n```\n\n# Analysis\n\n## Negative controls\n\nFirst, we'll check whether the experimental and plate negative controls look good\n\n```{r}\nfinaltable %>% \n  filter(str_detect(community_type, \"^neg|pos\")) %>% \n  summarize(tot = sum(count_correct), .by = c(\"sample\", \"community_id\", \"n_species\", \"community_type\", \"replicate\"))\n```\n\nThis looks ok, but there are potentially some problems. Specifically, negative control replicates 2, 3, and 4 all have some contamination. `neg_2_0` seems to be contaminated with HAMBI_1977, `neg_3_0` with HAMBI_1287, and `neg_4_0` with HAMBI_1977. However in the 5 remaining negative controls there is no contamination.\n\n## Positive controls\n\nThe positive controls should each have three species. In all cases the species that shouldn't be there is very rare\n```{r}\nfinaltable %>% \n  filter(str_detect(community_type, \"^pos\")) %>%\n  mutate(total_pos_controls = n_distinct(sample)) %>% \n  group_by(sample) %>% \n  mutate(f = round(count_correct/sum(count_correct)*100)) %>%\n  mutate(supposed_2_b_there = if_else(is.na(evo_hist), \"no\", \"yes\")) %>% \n  relocate(f, supposed_2_b_there) %>% \n  distinct(f, supposed_2_b_there, sample, strainID, count_correct, n_species, community_type,)\n```\nThis is also good - we detect all 3 species that should be there in the positive controls on each plate. In a later step we will use these control samples with `metacal` to try and correct for the boil prep extraction method. \n\n## Misassigned reads\n\nThese libraries were only prepared with samples from Milla's 4-species experiment with 403, 1287, 1896, and 1977 so any time species other than these show up is just an incorrect assignment by Rbec. Let's check quickly how many of these there are...\n\n```{r}\nfinaltable %>% \n  filter(!str_detect(strainID, \"0403|1287|1896|1977\"))\n```\n\nThere is one or two incorrectly assigned reads here and there but this is just noise. We can safely exclude all reads not mapping to one of the focal species.\n\n```{r}\nfinaltable <- finaltable %>% \n  filter(str_detect(strainID, \"0403|1287|1896|1977\"))\n```\n\n## Samples with too few reads\n\nSome of the experimental pairs had streptomycin concentrations higher than any of the species individually could tolerate. We would naively expect then that neither species would grow successfully in these samples and that the overall biomass would be very low, thus resulting in a low number of recovered reads from these samples.\n\nTo look into this. first let's check which samples have very low OD600 in the endpoint samples.\n\n```{r}\nod <- read_tsv(here::here(\"_data_raw\", \"20240606_optical_density\", \"optical_density_formatted.tsv\"))\n```\n\n```{r}\nfiltids <- finaltable %>% \n  summarize(tot = sum(count_correct), .by = c(sample, community_id, n_species, transfers, strep_conc, replicate)) %>%\n  left_join(od, by = join_by(community_id, n_species, transfers, strep_conc, replicate)) %>% \n  filter(transfers == 8) %>% \n  arrange(tot) %>% \n  arrange(OD) %>% \n  filter(OD < 0.1 | tot < 1000) %>% \n  pull(sample)\n```\n\nWe'll filter out samples with an OD of less than 0.1 and also samples with fewer than 1000 reads. It is genearlly good practice to exclude samples with low number of reads.\n\n```{r}\nfinaltable <- finaltable %>% \n  filter(sample %nin% filtids)\n```\n\n## Masterplate samples\n\nTo set up this experiment, Milla combined the species in the planned proportions on a masterplate. Because this process was time consuming, the masterplate was stored at -80C after construction until the experiment start day when it was taken from the freezer and used to inoculate the experiment. Because Milla knows exactly which strains were added to the master plate and the plates were not allowed to grow, any strains in these samples that are not supposed to be there should be due to Illumina index cross talk and not true contamination. We can get a sense for the average index crosstalk rate from these samples and then draw a threshold of when to exclude likely false positives and when a positive is likely due to contamination.\n\n```{r}\nmasterplate <- finaltable %>%\n  filter(community_type == \"masterplate\") %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup()\n```\n\nHere we focus on masterplate samples with species that should not be there. We exclude species that were inoculated and plot the distribution of percentages of those species\n\n::: {#fig-01}\n```{r}\n#| fig.width: 8\n#| fig.height: 3\nmasterplate %>% \n  # here we take advantage of the fact that for species not supposed to be in a sample\n  # the prior left_join will have filled the evo_hist category with an NA. We can then filter\n  # on this NA value\n  filter(is.na(evo_hist)) %>% \n  filter(f > 0) %>% \n  ggplot(aes(x = f)) +\n  geom_histogram(aes(fill = strainID), bins = 20) +\n  geom_vline(xintercept = 0.01, linetype = \"dashed\") +\n  scale_fill_manual(values = hambi_colors) +\n  scale_x_continuous(trans = \"log10\",  labels = percent, guide = guide_axis(angle=90)) + \n  labs(x = \"Crosstalk frequency\", y = \"Count\") +\n  facet_grid(~strainID) + \n  annotation_logticks(sides = \"b\", color=\"grey30\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\")\n```\n\nFrequency distribution of each species in masterplate samples where it **should not** occur. The 1% mark (commonly accepted as an acceptable Illumina cross-talk standard) is demarcated with a dashed line. \n:::\n\nGenerally, the cross talk frequency is pretty OK. For 3/4 species it is 1% or less which is more or less what you can expect when you are multiplexing libraries on an Illumina platform. Values greater than 1% are potentially indicative of a different problem, so 1977 requires a bit more investigation.\n\n```{r}\nsids <- masterplate %>% \n  filter(is.na(evo_hist)) %>% \n  filter(f > 0.01 & strainID == \"HAMBI_1977\") %>% \n  pull(sample) \n\nmasterplate %>% \n  filter(sample %in% sids) %>% \n  dplyr::select(sample, strainID, count_correct, replicate, evo_hist, target_f, f)\n```\n\nIt looks like all the \"problematic\" samples come from plates 7 and 8 in the library prep. Plate 8 only contains the masterplate samples from trios whereas plate 7 contains both masterplate and experimental samples. @Fig-02 shows that HAMBI-1977 is very abundant in many of the samples so likely the \"leaky\" reads come disproportionately from HAMBI-1977 which is why its crosstalk threshold may be higher (@Fig-01). \n\n::: {#fig-02}\n```{r}\n#| fig.width: 8\n#| fig.height: 3\nfinaltable %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # here we take advantage of the fact that for species not supposed to be in a sample\n  # the prior left_join will have filled the evo_hist category with an NA. We can then filter\n  # on this NA value\n  filter(!is.na(evo_hist)) %>% \n  filter(f > 0) %>% \n  ggplot(aes(x = f)) +\n  geom_histogram(aes(fill = strainID), bins = 20) +\n  scale_fill_manual(values = hambi_colors) +\n  scale_x_continuous(trans = \"log10\",  labels = percent, guide = guide_axis(angle=90)) + \n  labs(x = \"Frequency in samples\", y = \"Count\") +\n  facet_grid(~strainID) + \n  annotation_logticks(sides = \"b\", color=\"grey30\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\")\n```\nFrequency distribution of each species in all samples where it **should** occur.\n:::\n\nAnyway, I don't think this is a problem and that we can move forward with these samples. However, to define extinction/competitive exclusion we may need to use a higher threshold than 1% (e.g., 3% frequency) because over 3% we can reliably say that a species is present and it is not due to index cross talk.\n\n## Experimental samples\n\nNow we need to see how our experimental samples performed and if there are species present in them that shouldn't be there\n\n```{r}\nexp_contam <- finaltable %>% \n  filter(str_detect(community_type, \"experiment\")) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # because we set 3% as our limit of detection we set read counts of species \n  # less than 1% to 0\n  mutate(count_correct_thresh = if_else(f <= 0.03, 0, count_correct)) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct_thresh/sum(count_correct_thresh)) %>% \n  ungroup()\n```\n\n\n::: {#fig-03}\n```{r}\n#| fig.width: 8\n#| fig.height: 3\nexp_contam %>% \n  filter(is.na(evo_hist)) %>% \n  ggplot(aes(x = f)) +\n  geom_histogram(aes(fill = strainID), bins = 20) +\n  scale_fill_manual(values = hambi_colors) +\n  scale_x_continuous(trans = \"log10\",  labels = percent, guide = guide_axis(angle=90)) + \n  labs(x = \"Frequency in samples\", y = \"Count\") +\n  facet_grid(~ strainID) + \n  annotation_logticks(sides = \"b\", color=\"grey30\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\")\n```\nFrequency distribution of each species in experimental samples where it **should not** occcur.\n:::\n\n```{r}\n#| eval: true\n#| echo: false\n#| output: false\ntotsamp <- exp_contam %>% \n  summarize(n_distinct(sample)) %>% \n  pull()\n\ncontamsamp <- exp_contam %>% \n  filter(f > 0) %>% \n  filter(is.na(evo_hist)) %>% \n  summarize(n_distinct(sample)) %>% \n  pull()\n```\n\nIt's not too bad... but `{r} contamsamp` of `{r} totsamp` samples (`{r} round(contamsamp/totsamp*100, 1)`%) have probably been contaminated because they contain a species that shouldn't be in the sample (using the 3% relative abundance as a robust threshold for presence/absence).\n\n### Contaminated pairs\n\nTaking a closer look at specific experimental samples with contamination.\n\nHere we just select samples that have > 3% of a species that shouldn't be there and prepare them for plotting.\n```{r}\ncontamsampid <- exp_contam %>% \n  filter(f > 0) %>% \n  filter(is.na(evo_hist)) %>% \n  pull(sample)\n\nspcols <- c(\"HAMBI_0403_anc\" = \"#faa019\",\n            \"HAMBI_0403_evo\" = \"#bd7811\",\n            \"HAMBI_1287_anc\" = \"#75afff\",\n            \"HAMBI_1287_evo\" = \"#476c9e\",\n            \"HAMBI_1896_anc\" = \"#59cc4e\",\n            \"HAMBI_1896_evo\" = \"#31752a\",\n            \"HAMBI_1977_anc\" = \"#ffd430\",\n            \"HAMBI_1977_evo\" = \"#ab8e1f\",\n            \n            \"HAMBI_0403_NA\"  = \"#e6e5e3\",\n            \"HAMBI_1287_NA\"  = \"#bdbcbb\",\n            \"HAMBI_1896_NA\"  = \"#8c8c8b\",\n            \"HAMBI_1977_NA\"  = \"#333333\"\n            )\n\nexp_contam_plot <- exp_contam %>%\n  filter(sample %in% contamsampid) %>% \n  mutate(sp = paste0(strainID, \"_\", evo_hist))\n```\n\n\n::: {#fig-04}\n```{r}\n#| fig.width: 8\n#| fig.height: 6\nexp_contam_plot %>% \n  filter(n_species == 2) %>% \n  ggplot() +\n  geom_col(aes(x = sample, y=f, fill = sp)) +\n  facet_wrap( ~ strep_conc, scales = \"free_x\", ncol = 2) +\n  labs(y = \"Abundance\", x = \"\", fill = \"\") +\n  scale_fill_manual(values = spcols) +\n  scale_y_continuous(labels = percent) +\n  scale_x_discrete(guide = guide_axis(angle=90)) +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"right\")\n```\nSpecies composition of pair samples that contain > 3% of a species that shouldn't be there (shown in grey to black).\n:::\n\nI think pretty much the only way to deal with this is to inspect manually. Most of the comtaminated samples are in the 0 Streptomycin conditions. I think we should exclude samples where the contamination is very high (over ~50% of the sample) but those with 10% or less contaminant I think can be retained, and I will discard the contaminating sequences.\n\n```{r}\nnotcontampairs <- c(\"P04_1_0\", \"P45_2_0\", \"P01_2_64\", \"P03_2_64\", \n                    \"P06_1_256\", \"P17_2_256\", \"P30_1_256\", \"P30_2_256\", \n                    \"P41_2_256\")\n\ncontampairs <- setdiff(contamsampid[grepl(\"^P\", contamsampid)], notcontampairs)\n```\n\n\n### Contaminated trios\n\nNow we'll do the same thing and inspect the trios.\n\n::: {#fig-04}\n```{r}\n#| fig.width: 8\n#| fig.height: 4\nexp_contam_plot %>% \n  filter(n_species == 3) %>% \n  ggplot() +\n  geom_col(aes(x = sample, y=f, fill = sp)) +\n  labs(y = \"Abundance\", x = \"\", fill = \"\") +\n  scale_fill_manual(values = spcols) +\n  scale_y_continuous(labels = percent) +\n  scale_x_discrete(guide = guide_axis(angle=90)) +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"right\")\n```\nSpecies composition of trio samples that contain > 3% of a species that shouldn't be there (shown in grey to black).\n:::\n\nAgain, I think we should exclude samples where the contamination is very high (over ~50% of the sample) but those with around 10% or less contaminant I think can be retained, and I will discard the contaminating sequences.\n\n```{r}\nnotcontamtrios <- c(\"T01_2_0\", \"T02_2_0\", \"T04_2_0\", \"T05_2_0\", \"T13_2_0\", \n                    \"T14_2_0\", \"T15_1_0\", \"T15_2_0\", \"T16_1_0\", \"T16_2_0\", \n                    \"T17_2_0\", \"T18_2_0\",\"T31_2_0\", \"T45_1_0\", \"T45_2_0\", \n                    \"T55_1_0\", \"T61_1_0\", \"T61_2_0\", \"T64_1_0\", \"T64_2_0\")\n\ncontamtrios <- setdiff(contamsampid[grepl(\"^T\", contamsampid)], notcontamtrios)\n```\n\n# Export\n\n## pos/neg control samples\n\nSeparate out the pos/neg control samples\n```{r}\nfinaltable %>% \n  filter(str_detect(community_type, \"^pos|^neg\")) %>% \n  dplyr::select(-transfers, -strep_conc, -evo_hist, -target_f, -count) %>% \n  write_tsv(here::here(data, \"pos_neg_ctrl_counts.tsv\"))\n```\n\n## Pairs\n\nseparate, format, and write the pair samples\n```{r}\npairs <- finaltable %>% \n  filter(!str_detect(community_type, \"^pos|^neg\")) %>%\n  filter(n_species == 2) %>% \n  filter(sample %nin% contampairs) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # because we set 3% as our limit of detection we set read counts of species \n  # less than 1% to 0\n  mutate(count_correct_thresh = if_else(f <= 0.03, 0, count_correct)) %>% \n  # also exclude any remaining counts from species that shouldnt be there\n  # using again the fact that evo_hist should be NA for these species\n  filter(!is.na(evo_hist)) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct_thresh/sum(count_correct_thresh)) %>% \n  ungroup() %>%\n  dplyr::select(sample, strainID, evo_hist, count_correct, count_correct_thresh, \n                f, target_f, replicate, strep_conc, transfers, n_species, community_type, plate_well)\n\nwrite_tsv(pairs, here::here(data, \"pairs_counts.tsv\"))\n```\n\n## Trios\n```{r}\ntrios <- finaltable %>% \n  filter(!str_detect(community_type, \"^pos|^neg\")) %>%\n  filter(n_species == 3) %>% \n  filter(sample %nin% contamtrios) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # because we set 3% as our limit of detection we set read counts of species \n  # less than 1% to 0\n  mutate(count_correct_thresh = if_else(f <= 0.03, 0, count_correct)) %>% \n  # also exclude any remaining counts from species that shouldnt be there\n  # using again the fact that evo_hist should be NA for these species\n  filter(!is.na(evo_hist)) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct_thresh/sum(count_correct_thresh)) %>% \n  ungroup() %>%\n  dplyr::select(sample, strainID, evo_hist, count_correct, count_correct_thresh, \n                f, target_f, replicate, strep_conc, transfers, n_species, community_type, plate_well)\n\nwrite_tsv(trios, here::here(data, \"trios_counts.tsv\"))\n```\n\n# Clean up\n\n```{r}\n# remove decompressed coverage directory from temp location\nfs::dir_delete(tmpdir)\n```\n\n","srcMarkdownNoYaml":"\n\n# Introduction\n\nContains results from pairs of all streptomycin concentrations and trios for 0 streptomycin from Milla's bottom up community assembly experiment\n\n# Setup\n\n## Libraries\n\n```{r}\n#| output: false\nlibrary(tidyverse)\nlibrary(here)\nlibrary(fs)\nlibrary(archive)\nlibrary(scales)\nsource(here::here(\"R\", \"utils_generic.R\"))\n```\n\n## Global variables\n\n```{r}\ndata_raw <- here::here(\"_data_raw\", \"20240711_BTK_illumina_v3\")\ndata <- here::here(\"data\", \"20240711_BTK_illumina_v3\")\namplicontar <- here::here(data_raw, \"rbec_output.tar.gz\")\n\n# make processed data directory if it doesn't exist\nfs::dir_create(data)\n\n# create temporary location to decompress\ntmpdir <- fs::file_temp()\n```\n\n## Data\n\nNOTE! We have commented out the species not included in this experiment  \n```{r}\ntax_locus_copynum <- tibble::tribble(\n     ~strainID, ~rRNA16S_cn, ~rRNA16S_locus,             ~genus,        ~species,\n  \"HAMBI_0006\",          7L,  \"H0006_04757\",      \"Pseudomonas\",        \"putida\",\n  \"HAMBI_0097\",          7L,  \"H0097_00044\",    \"Acinetobacter\",     \"johnsonii\",\n  \"HAMBI_0097\",          7L,  \"H0097_02759\",    \"Acinetobacter\",     \"johnsonii\",\n  \"HAMBI_0097\",          7L,  \"H0097_01762\",    \"Acinetobacter\",     \"johnsonii\",\n  \"HAMBI_0105\",          4L,  \"H0105_02306\",    \"Agrobacterium\",   \"tumefaciens\",\n  \"HAMBI_0262\",          3L,  \"H0262_00030\",    \"Brevundimonas\",       \"bullata\",\n  \"HAMBI_0403\",          9L,  \"H0403_00517\",        \"Comamonas\",  \"testosteroni\",\n  \"HAMBI_0403\",          9L,  \"H0403_00522\",        \"Comamonas\",  \"testosteroni\",\n  \"HAMBI_1279\",          7L,  \"H1279_03627\",           \"Hafnia\",         \"alvei\",\n  \"HAMBI_1279\",          7L,  \"H1279_00125\",           \"Hafnia\",         \"alvei\",\n  \"HAMBI_1279\",          7L,  \"H1279_03957\",           \"Hafnia\",         \"alvei\",\n  \"HAMBI_1287\",          7L,  \"H1287_03997\",      \"Citrobacter\",        \"koseri\",\n  \"HAMBI_1287\",          7L,  \"H1287_03402\",      \"Citrobacter\",        \"koseri\",\n  \"HAMBI_1292\",          7L,  \"H1292_03239\",       \"Morganella\",      \"morganii\",\n  \"HAMBI_1299\",          8L,  \"H1299_04293\",         \"Kluyvera\",    \"intermedia\",\n  \"HAMBI_1299\",          8L,  \"H1299_01283\",         \"Kluyvera\",    \"intermedia\",\n  \"HAMBI_1299\",          8L,  \"H1279_03957\",         \"Kluyvera\",    \"intermedia\",\n  \"HAMBI_1842\",          4L,  \"H1842_01650\",      \"Sphingobium\",    \"yanoikuyae\",\n  \"HAMBI_1896\",          4L,  \"H1896_00963\", \"Sphingobacterium\",  \"spiritivorum\",\n  \"HAMBI_1972\",         10L,  \"H1972_00343\",        \"Aeromonas\",        \"caviae\",\n  \"HAMBI_1972\",         10L,  \"H1972_03531\",        \"Aeromonas\",        \"caviae\",\n  \"HAMBI_1977\",          5L,  \"H1977_00118\",      \"Pseudomonas\",  \"chlororaphis\",\n  \"HAMBI_1988\",          5L,  \"H1988_05160\",     \"Chitinophaga\",        \"sancti\",\n  \"HAMBI_1988\",          5L,  \"H1988_05152\",     \"Chitinophaga\",        \"sancti\",\n  \"HAMBI_1988\",          5L,  \"H1988_05165\",     \"Chitinophaga\",        \"sancti\",\n  \"HAMBI_2159\",          4L,  \"H2159_01406\",        \"Trinickia\",   \"caryophylli\",\n  \"HAMBI_2159\",          4L,  \"H2159_05851\",        \"Trinickia\",   \"caryophylli\",\n  \"HAMBI_2160\",          3L,  \"H2160_00530\",       \"Bordetella\",         \"avium\",\n  \"HAMBI_2164\",          5L,  \"H2164_03337\",      \"Cupriavidus\",    \"oxalaticus\",\n  \"HAMBI_2443\",          3L,  \"H2443_00128\",       \"Paracoccus\", \"denitrificans\",\n  \"HAMBI_2494\",          4L,  \"H2494_03389\", \"Paraburkholderia\",   \"kururiensis\",\n  \"HAMBI_2659\",          4L,  \"H2659_00367\", \"Stenotrophomonas\",   \"maltophilia\",\n  \"HAMBI_2792\",          4L,  \"H2792_00549\",        \"Moraxella\",         \"canis\",\n  \"HAMBI_3031\",          2L,  \"H3031_00830\",         \"Niabella\",  \"yanshanensis\",\n  \"HAMBI_3237\",          6L,  \"H3237_00875\",       \"Microvirga\",   \"lotononidis\",\n  \"HAMBI_1923\",          6L,  \"H1923_00876\",   \"Flavobacterium\",      \"odoratum\"\n  )\n```\n\n## Functions\n```{r}\n# this function \nnormalize_by_copy <- function(.data, tlc = tax_locus_copynum){\n  .data %>% \n    # join with the copy number data frame. We join by the locus tag so this will add H1279_03957 to HAMBI_1299\n    dplyr::left_join(tlc, by = join_by(rRNA16S_locus)) %>%\n    # get total number of mapping reads per species. This aggregates all the difference ASVs per species\n    dplyr::summarize(count = sum(count), .by = c(sample, strainID, rRNA16S_cn)) %>% \n    # group by sample\n    dplyr::group_by(sample) %>% \n    # calculate a corrected count which is simply the count divided by copy num for each species\n    # dividide by the sum of count divided by copy num for whole sample multiplied by the total\n    # number of mapped reads per sample\n    dplyr::mutate(count_correct = round(sum(count)*(count/rRNA16S_cn)/sum(count/rRNA16S_cn))) %>%  \n    dplyr::ungroup() %>% \n    dplyr::select(sample, strainID, count, count_correct)\n  }\n\n# this function replaces missing species counts with zero\ncompletecombos <- function(.data, tlc = tax_locus_copynum, countname = count, remove1923 = TRUE){\n \n  # get unique strainIDs\n  strainID <- unique(tlc$strainID)\n  # table for assigning genus and species names. Doesn't matter if 1923 is there or not\n  # because it is filter joined later\n  tax <- dplyr::distinct(dplyr::select(tlc, strainID, genus, species))\n  if (remove1923) {\n    # get unique strainIDs but exclude 1923 if remove1923 is true\n    strainID <- strainID[strainID != \"HAMBI_1923\"]\n  }\n  \n  dplyr::bind_rows(tibble::tibble(strainID = strainID, sample = \"dummy\"), .data) %>% \n    dplyr::mutate( \"{{ countname }}\" := dplyr::if_else(sample == \"dummy\", 1, {{ countname }})) %>% \n    tidyr::complete(sample, strainID) %>% \n    dplyr::filter(sample != \"dummy\") %>% \n    dplyr::mutate( \"{{ countname }}\" := dplyr::if_else(is.na({{ countname }}), 0, {{ countname }})) %>% \n    tidyr::replace_na(list(count_correct = 0)) %>% \n    dplyr::left_join(dplyr::distinct(dplyr::select(tlc, strainID, genus, species))) %>% \n    dplyr::relocate(genus, species, .after = strainID)\n}\n```\n\n# Read metadata\n\n```{r}\nmddf <- readr::read_tsv(here::here(data_raw, \"20240711_BTK_illumina_v3_metadata.tsv\"))\nspdf <- readr::read_tsv(here::here(data_raw, \"sample_compositions.tsv\"))\n```\n\n# Read Rbec raw counts tables \n\n## Untar Rbec output tarball\n\n```{r}\narchive::archive_extract(\n  amplicontar,\n  dir = tmpdir,\n  files = NULL,\n  options = character(),\n  strip_components = 0L\n)\n```\n\n## Setup directory structure\n\n```{r}\ntabdir <- here::here(tmpdir, \"rbec_output\")\nsamppaths <- fs::dir_ls(tabdir)\nsampnames <- path_split(samppaths) %>% \n  map_chr(dplyr::last)\n```\n\n## Read\n\n```{r}\nstraintabs <- paste0(samppaths, \"/strain_table.txt\") %>% \n  set_names(sampnames) %>% \n  map_df(\n  read_tsv,\n  skip = 1,\n  col_names = c(\"rRNA16S_locus\",\"count\"),\n  show_col_types = FALSE, \n  .id = \"sample\") %>% \n  # naming scheme inconsistent for one sample\n  mutate(sample = if_else(sample == \"P2_s_0\", \"P02_s_0\", sample))\n```\n\n# Format\n\nNormalize counts by 16S copy number\n```{r}\nstraintabs_norm <- normalize_by_copy(straintabs)\n```\n\n```{r}\nfinaltable <- left_join(straintabs_norm, mddf) %>% \n  left_join(spdf)\n```\n\n# Analysis\n\n## Negative controls\n\nFirst, we'll check whether the experimental and plate negative controls look good\n\n```{r}\nfinaltable %>% \n  filter(str_detect(community_type, \"^neg|pos\")) %>% \n  summarize(tot = sum(count_correct), .by = c(\"sample\", \"community_id\", \"n_species\", \"community_type\", \"replicate\"))\n```\n\nThis looks ok, but there are potentially some problems. Specifically, negative control replicates 2, 3, and 4 all have some contamination. `neg_2_0` seems to be contaminated with HAMBI_1977, `neg_3_0` with HAMBI_1287, and `neg_4_0` with HAMBI_1977. However in the 5 remaining negative controls there is no contamination.\n\n## Positive controls\n\nThe positive controls should each have three species. In all cases the species that shouldn't be there is very rare\n```{r}\nfinaltable %>% \n  filter(str_detect(community_type, \"^pos\")) %>%\n  mutate(total_pos_controls = n_distinct(sample)) %>% \n  group_by(sample) %>% \n  mutate(f = round(count_correct/sum(count_correct)*100)) %>%\n  mutate(supposed_2_b_there = if_else(is.na(evo_hist), \"no\", \"yes\")) %>% \n  relocate(f, supposed_2_b_there) %>% \n  distinct(f, supposed_2_b_there, sample, strainID, count_correct, n_species, community_type,)\n```\nThis is also good - we detect all 3 species that should be there in the positive controls on each plate. In a later step we will use these control samples with `metacal` to try and correct for the boil prep extraction method. \n\n## Misassigned reads\n\nThese libraries were only prepared with samples from Milla's 4-species experiment with 403, 1287, 1896, and 1977 so any time species other than these show up is just an incorrect assignment by Rbec. Let's check quickly how many of these there are...\n\n```{r}\nfinaltable %>% \n  filter(!str_detect(strainID, \"0403|1287|1896|1977\"))\n```\n\nThere is one or two incorrectly assigned reads here and there but this is just noise. We can safely exclude all reads not mapping to one of the focal species.\n\n```{r}\nfinaltable <- finaltable %>% \n  filter(str_detect(strainID, \"0403|1287|1896|1977\"))\n```\n\n## Samples with too few reads\n\nSome of the experimental pairs had streptomycin concentrations higher than any of the species individually could tolerate. We would naively expect then that neither species would grow successfully in these samples and that the overall biomass would be very low, thus resulting in a low number of recovered reads from these samples.\n\nTo look into this. first let's check which samples have very low OD600 in the endpoint samples.\n\n```{r}\nod <- read_tsv(here::here(\"_data_raw\", \"20240606_optical_density\", \"optical_density_formatted.tsv\"))\n```\n\n```{r}\nfiltids <- finaltable %>% \n  summarize(tot = sum(count_correct), .by = c(sample, community_id, n_species, transfers, strep_conc, replicate)) %>%\n  left_join(od, by = join_by(community_id, n_species, transfers, strep_conc, replicate)) %>% \n  filter(transfers == 8) %>% \n  arrange(tot) %>% \n  arrange(OD) %>% \n  filter(OD < 0.1 | tot < 1000) %>% \n  pull(sample)\n```\n\nWe'll filter out samples with an OD of less than 0.1 and also samples with fewer than 1000 reads. It is genearlly good practice to exclude samples with low number of reads.\n\n```{r}\nfinaltable <- finaltable %>% \n  filter(sample %nin% filtids)\n```\n\n## Masterplate samples\n\nTo set up this experiment, Milla combined the species in the planned proportions on a masterplate. Because this process was time consuming, the masterplate was stored at -80C after construction until the experiment start day when it was taken from the freezer and used to inoculate the experiment. Because Milla knows exactly which strains were added to the master plate and the plates were not allowed to grow, any strains in these samples that are not supposed to be there should be due to Illumina index cross talk and not true contamination. We can get a sense for the average index crosstalk rate from these samples and then draw a threshold of when to exclude likely false positives and when a positive is likely due to contamination.\n\n```{r}\nmasterplate <- finaltable %>%\n  filter(community_type == \"masterplate\") %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup()\n```\n\nHere we focus on masterplate samples with species that should not be there. We exclude species that were inoculated and plot the distribution of percentages of those species\n\n::: {#fig-01}\n```{r}\n#| fig.width: 8\n#| fig.height: 3\nmasterplate %>% \n  # here we take advantage of the fact that for species not supposed to be in a sample\n  # the prior left_join will have filled the evo_hist category with an NA. We can then filter\n  # on this NA value\n  filter(is.na(evo_hist)) %>% \n  filter(f > 0) %>% \n  ggplot(aes(x = f)) +\n  geom_histogram(aes(fill = strainID), bins = 20) +\n  geom_vline(xintercept = 0.01, linetype = \"dashed\") +\n  scale_fill_manual(values = hambi_colors) +\n  scale_x_continuous(trans = \"log10\",  labels = percent, guide = guide_axis(angle=90)) + \n  labs(x = \"Crosstalk frequency\", y = \"Count\") +\n  facet_grid(~strainID) + \n  annotation_logticks(sides = \"b\", color=\"grey30\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\")\n```\n\nFrequency distribution of each species in masterplate samples where it **should not** occur. The 1% mark (commonly accepted as an acceptable Illumina cross-talk standard) is demarcated with a dashed line. \n:::\n\nGenerally, the cross talk frequency is pretty OK. For 3/4 species it is 1% or less which is more or less what you can expect when you are multiplexing libraries on an Illumina platform. Values greater than 1% are potentially indicative of a different problem, so 1977 requires a bit more investigation.\n\n```{r}\nsids <- masterplate %>% \n  filter(is.na(evo_hist)) %>% \n  filter(f > 0.01 & strainID == \"HAMBI_1977\") %>% \n  pull(sample) \n\nmasterplate %>% \n  filter(sample %in% sids) %>% \n  dplyr::select(sample, strainID, count_correct, replicate, evo_hist, target_f, f)\n```\n\nIt looks like all the \"problematic\" samples come from plates 7 and 8 in the library prep. Plate 8 only contains the masterplate samples from trios whereas plate 7 contains both masterplate and experimental samples. @Fig-02 shows that HAMBI-1977 is very abundant in many of the samples so likely the \"leaky\" reads come disproportionately from HAMBI-1977 which is why its crosstalk threshold may be higher (@Fig-01). \n\n::: {#fig-02}\n```{r}\n#| fig.width: 8\n#| fig.height: 3\nfinaltable %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # here we take advantage of the fact that for species not supposed to be in a sample\n  # the prior left_join will have filled the evo_hist category with an NA. We can then filter\n  # on this NA value\n  filter(!is.na(evo_hist)) %>% \n  filter(f > 0) %>% \n  ggplot(aes(x = f)) +\n  geom_histogram(aes(fill = strainID), bins = 20) +\n  scale_fill_manual(values = hambi_colors) +\n  scale_x_continuous(trans = \"log10\",  labels = percent, guide = guide_axis(angle=90)) + \n  labs(x = \"Frequency in samples\", y = \"Count\") +\n  facet_grid(~strainID) + \n  annotation_logticks(sides = \"b\", color=\"grey30\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\")\n```\nFrequency distribution of each species in all samples where it **should** occur.\n:::\n\nAnyway, I don't think this is a problem and that we can move forward with these samples. However, to define extinction/competitive exclusion we may need to use a higher threshold than 1% (e.g., 3% frequency) because over 3% we can reliably say that a species is present and it is not due to index cross talk.\n\n## Experimental samples\n\nNow we need to see how our experimental samples performed and if there are species present in them that shouldn't be there\n\n```{r}\nexp_contam <- finaltable %>% \n  filter(str_detect(community_type, \"experiment\")) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # because we set 3% as our limit of detection we set read counts of species \n  # less than 1% to 0\n  mutate(count_correct_thresh = if_else(f <= 0.03, 0, count_correct)) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct_thresh/sum(count_correct_thresh)) %>% \n  ungroup()\n```\n\n\n::: {#fig-03}\n```{r}\n#| fig.width: 8\n#| fig.height: 3\nexp_contam %>% \n  filter(is.na(evo_hist)) %>% \n  ggplot(aes(x = f)) +\n  geom_histogram(aes(fill = strainID), bins = 20) +\n  scale_fill_manual(values = hambi_colors) +\n  scale_x_continuous(trans = \"log10\",  labels = percent, guide = guide_axis(angle=90)) + \n  labs(x = \"Frequency in samples\", y = \"Count\") +\n  facet_grid(~ strainID) + \n  annotation_logticks(sides = \"b\", color=\"grey30\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\")\n```\nFrequency distribution of each species in experimental samples where it **should not** occcur.\n:::\n\n```{r}\n#| eval: true\n#| echo: false\n#| output: false\ntotsamp <- exp_contam %>% \n  summarize(n_distinct(sample)) %>% \n  pull()\n\ncontamsamp <- exp_contam %>% \n  filter(f > 0) %>% \n  filter(is.na(evo_hist)) %>% \n  summarize(n_distinct(sample)) %>% \n  pull()\n```\n\nIt's not too bad... but `{r} contamsamp` of `{r} totsamp` samples (`{r} round(contamsamp/totsamp*100, 1)`%) have probably been contaminated because they contain a species that shouldn't be in the sample (using the 3% relative abundance as a robust threshold for presence/absence).\n\n### Contaminated pairs\n\nTaking a closer look at specific experimental samples with contamination.\n\nHere we just select samples that have > 3% of a species that shouldn't be there and prepare them for plotting.\n```{r}\ncontamsampid <- exp_contam %>% \n  filter(f > 0) %>% \n  filter(is.na(evo_hist)) %>% \n  pull(sample)\n\nspcols <- c(\"HAMBI_0403_anc\" = \"#faa019\",\n            \"HAMBI_0403_evo\" = \"#bd7811\",\n            \"HAMBI_1287_anc\" = \"#75afff\",\n            \"HAMBI_1287_evo\" = \"#476c9e\",\n            \"HAMBI_1896_anc\" = \"#59cc4e\",\n            \"HAMBI_1896_evo\" = \"#31752a\",\n            \"HAMBI_1977_anc\" = \"#ffd430\",\n            \"HAMBI_1977_evo\" = \"#ab8e1f\",\n            \n            \"HAMBI_0403_NA\"  = \"#e6e5e3\",\n            \"HAMBI_1287_NA\"  = \"#bdbcbb\",\n            \"HAMBI_1896_NA\"  = \"#8c8c8b\",\n            \"HAMBI_1977_NA\"  = \"#333333\"\n            )\n\nexp_contam_plot <- exp_contam %>%\n  filter(sample %in% contamsampid) %>% \n  mutate(sp = paste0(strainID, \"_\", evo_hist))\n```\n\n\n::: {#fig-04}\n```{r}\n#| fig.width: 8\n#| fig.height: 6\nexp_contam_plot %>% \n  filter(n_species == 2) %>% \n  ggplot() +\n  geom_col(aes(x = sample, y=f, fill = sp)) +\n  facet_wrap( ~ strep_conc, scales = \"free_x\", ncol = 2) +\n  labs(y = \"Abundance\", x = \"\", fill = \"\") +\n  scale_fill_manual(values = spcols) +\n  scale_y_continuous(labels = percent) +\n  scale_x_discrete(guide = guide_axis(angle=90)) +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"right\")\n```\nSpecies composition of pair samples that contain > 3% of a species that shouldn't be there (shown in grey to black).\n:::\n\nI think pretty much the only way to deal with this is to inspect manually. Most of the comtaminated samples are in the 0 Streptomycin conditions. I think we should exclude samples where the contamination is very high (over ~50% of the sample) but those with 10% or less contaminant I think can be retained, and I will discard the contaminating sequences.\n\n```{r}\nnotcontampairs <- c(\"P04_1_0\", \"P45_2_0\", \"P01_2_64\", \"P03_2_64\", \n                    \"P06_1_256\", \"P17_2_256\", \"P30_1_256\", \"P30_2_256\", \n                    \"P41_2_256\")\n\ncontampairs <- setdiff(contamsampid[grepl(\"^P\", contamsampid)], notcontampairs)\n```\n\n\n### Contaminated trios\n\nNow we'll do the same thing and inspect the trios.\n\n::: {#fig-04}\n```{r}\n#| fig.width: 8\n#| fig.height: 4\nexp_contam_plot %>% \n  filter(n_species == 3) %>% \n  ggplot() +\n  geom_col(aes(x = sample, y=f, fill = sp)) +\n  labs(y = \"Abundance\", x = \"\", fill = \"\") +\n  scale_fill_manual(values = spcols) +\n  scale_y_continuous(labels = percent) +\n  scale_x_discrete(guide = guide_axis(angle=90)) +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"right\")\n```\nSpecies composition of trio samples that contain > 3% of a species that shouldn't be there (shown in grey to black).\n:::\n\nAgain, I think we should exclude samples where the contamination is very high (over ~50% of the sample) but those with around 10% or less contaminant I think can be retained, and I will discard the contaminating sequences.\n\n```{r}\nnotcontamtrios <- c(\"T01_2_0\", \"T02_2_0\", \"T04_2_0\", \"T05_2_0\", \"T13_2_0\", \n                    \"T14_2_0\", \"T15_1_0\", \"T15_2_0\", \"T16_1_0\", \"T16_2_0\", \n                    \"T17_2_0\", \"T18_2_0\",\"T31_2_0\", \"T45_1_0\", \"T45_2_0\", \n                    \"T55_1_0\", \"T61_1_0\", \"T61_2_0\", \"T64_1_0\", \"T64_2_0\")\n\ncontamtrios <- setdiff(contamsampid[grepl(\"^T\", contamsampid)], notcontamtrios)\n```\n\n# Export\n\n## pos/neg control samples\n\nSeparate out the pos/neg control samples\n```{r}\nfinaltable %>% \n  filter(str_detect(community_type, \"^pos|^neg\")) %>% \n  dplyr::select(-transfers, -strep_conc, -evo_hist, -target_f, -count) %>% \n  write_tsv(here::here(data, \"pos_neg_ctrl_counts.tsv\"))\n```\n\n## Pairs\n\nseparate, format, and write the pair samples\n```{r}\npairs <- finaltable %>% \n  filter(!str_detect(community_type, \"^pos|^neg\")) %>%\n  filter(n_species == 2) %>% \n  filter(sample %nin% contampairs) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # because we set 3% as our limit of detection we set read counts of species \n  # less than 1% to 0\n  mutate(count_correct_thresh = if_else(f <= 0.03, 0, count_correct)) %>% \n  # also exclude any remaining counts from species that shouldnt be there\n  # using again the fact that evo_hist should be NA for these species\n  filter(!is.na(evo_hist)) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct_thresh/sum(count_correct_thresh)) %>% \n  ungroup() %>%\n  dplyr::select(sample, strainID, evo_hist, count_correct, count_correct_thresh, \n                f, target_f, replicate, strep_conc, transfers, n_species, community_type, plate_well)\n\nwrite_tsv(pairs, here::here(data, \"pairs_counts.tsv\"))\n```\n\n## Trios\n```{r}\ntrios <- finaltable %>% \n  filter(!str_detect(community_type, \"^pos|^neg\")) %>%\n  filter(n_species == 3) %>% \n  filter(sample %nin% contamtrios) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # because we set 3% as our limit of detection we set read counts of species \n  # less than 1% to 0\n  mutate(count_correct_thresh = if_else(f <= 0.03, 0, count_correct)) %>% \n  # also exclude any remaining counts from species that shouldnt be there\n  # using again the fact that evo_hist should be NA for these species\n  filter(!is.na(evo_hist)) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct_thresh/sum(count_correct_thresh)) %>% \n  ungroup() %>%\n  dplyr::select(sample, strainID, evo_hist, count_correct, count_correct_thresh, \n                f, target_f, replicate, strep_conc, transfers, n_species, community_type, plate_well)\n\nwrite_tsv(trios, here::here(data, \"trios_counts.tsv\"))\n```\n\n# Clean up\n\n```{r}\n# remove decompressed coverage directory from temp location\nfs::dir_delete(tmpdir)\n```\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":8,"fig-height":6,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"number-sections":true,"output-file":"01_format_rbec_tab.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.553","editor":"source","theme":["cosmo","../../../mystyle.scss"],"tidy":true,"title":"Formatting Rbec output","author":"Shane Hogle","date":"today","link-citations":true},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}