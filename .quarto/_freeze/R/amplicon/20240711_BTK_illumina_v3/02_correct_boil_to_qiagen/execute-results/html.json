{
  "hash": "5f26b03fb3cb0407a9a89cdb53aef3f4",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Calibrate boilprep to Qiagen DNeasy\"\nauthor: \"Shane Hogle\"\ndate: today\nlink-citations: true\n---\n\n\n# Introduction\n\nWe will use the [metacal package](https://mikemc.github.io/metacal/) for estimating bias and performing calibration in the special case where the bias of all the taxa of interest can be directly measured from the control sample. Since samples extracted by Qiagen and by boil are exactly the same we can estimate scaling factors to produce corrected relative abundance for other samples.\n\nPublication: [Consistent and correctable bias in metagenomic sequencing experiments](https://elifesciences.org/articles/46923)\n\n# Setup\n\n## Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(here)\nlibrary(tidyverse)\nlibrary(metacal)\nlibrary(withr)\nlibrary(scales)\nsource(here::here(\"R\", \"utils_generic.R\"))\n```\n:::\n\n\n## Global variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_raw <- here::here(\"_data_raw\", \"20240711_BTK_illumina_v3\")\ndata <- here::here(\"data\", \"20240711_BTK_illumina_v3\")\n\n# make processed data directory if it doesn't exist\nfs::dir_create(data)\n```\n:::\n\n\n# Read data\n\n\n::: {.cell}\n\n```{.r .cell-code}\npos_ctrl <- read_tsv(here::here(data, \"pos_neg_ctrl_counts.tsv\"))\nsamp_pairs <- read_tsv(here::here(data, \"pairs_counts.tsv\"))\nsamp_trios <- read_tsv(here::here(data, \"trios_counts.tsv\"))\n\n# metadata\nmddf <- readr::read_tsv(here::here(data_raw, \"20240711_BTK_illumina_v3_metadata.tsv\"))\nspdf <- readr::read_tsv(here::here(data_raw, \"sample_compositions.tsv\"))\n```\n:::\n\n\n# Formatting\n\n## Format positive control samples\n\n\n::: {.cell}\n\n```{.r .cell-code}\npos_ctrl <- left_join(pos_ctrl, spdf) %>% \n  filter(str_detect(community_type, \"^pos\")) %>%\n  # remove noise from species that aren't really there\n  filter(!is.na(evo_hist)) %>% \n  group_by(sample) %>% \n  mutate(f_qg = count_correct/sum(count_correct)) %>% \n  dplyr::select(sample, strainID, community_id, count_correct, f_qg) %>% \n  ungroup()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nJoining with `by = join_by(strainID, community_id)`\n```\n\n\n:::\n:::\n\n\n## Plot masterplate Qiagen and boil-prep side by side\n\n::: {#fig-01}\n\n::: {.cell}\n\n```{.r .cell-code}\nleft_join(samp_trios, mddf,\n          by = join_by(sample, replicate, strep_conc, transfers, n_species, community_type, plate_well)) %>% \n  filter(community_type == \"masterplate\") %>% \n  right_join(pos_ctrl, by = join_by(strainID, community_id)) %>% \n  dplyr::select(community_id, strainID, f, f_qg) %>% \n  pivot_longer(c(f, f_qg)) %>% \n  ggplot() +\n    geom_bar(aes(y = value, x=interaction(name, community_id), fill = strainID), \n             color=\"black\",\n             linewidth=0.25, stat=\"identity\") +\n    scale_y_continuous(limits = c(0,1), expand = c(0, 0), labels = percent) +\n    scale_x_discrete(guide = guide_axis(angle = 90)) +\n    labs(x=\"\", y=\"% abundance\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\") +\n  scale_fill_manual(values = hambi_colors)\n```\n\n::: {.cell-output-display}\n![](02_correct_boil_to_qiagen_files/figure-html/unnamed-chunk-5-1.png){width=768}\n:::\n:::\n\nBar plot of masterplate samples extracted by the boilprep method (f) or the Qiagen DNeasy kit (qg). The community trios are appended to the extraction method on the x axs\n:::\n\n## Matrix of observed counts\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamp_trios_counts <- left_join(samp_trios, mddf) %>% \n  filter(community_type == \"masterplate\") %>% \n  filter(community_id %in% pull(pos_ctrl, community_id)) %>% \n  dplyr::select(community_id, strainID, count_correct) %>% \n  pivot_wider(names_from=\"strainID\", values_from=\"count_correct\") %>% \n  column_to_rownames(var=\"community_id\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>% \n  as.matrix()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nJoining with `by = join_by(sample, replicate, strep_conc, transfers, n_species,\ncommunity_type, plate_well)`\n```\n\n\n:::\n:::\n\n\n## Make a matrix of true proportions\n\n\n::: {.cell}\n\n```{.r .cell-code}\npos_ctrl_proportions <- pos_ctrl %>% \n  dplyr::select(community_id, strainID, f_qg) %>%\n  pivot_wider(names_from=\"strainID\", values_from=\"f_qg\") %>% \n  column_to_rownames(var=\"community_id\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>% \n  as.matrix()\n```\n:::\n\n\n# Metacal procedure\n\n## Estimate bias\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(12378)\nmc_fit_trios <- metacal::estimate_bias(samp_trios_counts, pos_ctrl_proportions, 1, boot=TRUE)\nmc_fit_trios_summary <- summary(mc_fit_trios)\nmc_fit_trios_summary_coef <-mc_fit_trios_summary[['coefficients']]\n```\n:::\n\n\n### Plot bias estimation\n\n::: {#fig-02}\n\n::: {.cell}\n\n```{.r .cell-code}\nmc_fit_trios_summary_coef %>% \n  mutate(taxon = fct_reorder(taxon, estimate)) |> \n  ggplot(aes(taxon, estimate, \n             ymin = estimate / gm_se^2, ymax = estimate * gm_se^2)) +\n  geom_hline(yintercept = 1, color = \"grey\") +\n  geom_pointrange(aes(color = taxon)) +\n  scale_color_manual(values = hambi_colors) +\n  labs(x = \"\", y = \"Bias estimate\", color = \"\") +\n  coord_flip() + \n  theme_bw() +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank())\n```\n\n::: {.cell-output-display}\n![](02_correct_boil_to_qiagen_files/figure-html/unnamed-chunk-9-1.png){width=768}\n:::\n:::\n\nBias estimates for each species from the metacal procedure.\n:::\n\n### Plot metacal model fit\n\n\n::: {.cell}\n\n```{.r .cell-code}\na <- as.data.frame(fitted(mc_fit_trios)) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample) %>% \n  mutate(type=\"Fitted\")\n\nb <- as.data.frame(pos_ctrl_proportions) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample) %>% \n  mutate(type=\"Actual\")\n\nc <- as.data.frame(samp_trios_counts/rowSums(samp_trios_counts)) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample,  values_to=\"observed\")\n```\n:::\n\n\n\n::: {#fig-03}\n\n::: {.cell}\n\n```{.r .cell-code}\nbind_rows(a,b) %>% \n  left_join(c) %>% \n  ggplot(aes(x=observed, y=value, color = name)) +\n  geom_abline(linetype = \"dashed\") +\n  geom_point() +\n  scale_color_manual(values = hambi_colors) +\n  labs(x = \"Species proportion in boil-prepped samples\", y = \"Species proportion in Qiagen-prepped samples\", color = \"\") +\n  facet_grid(~type) + \n  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) + \n  theme_bw() +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank())\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nJoining with `by = join_by(sample, name)`\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](02_correct_boil_to_qiagen_files/figure-html/unnamed-chunk-11-1.png){width=768}\n:::\n:::\n\nPorportion of each species from boil-prepped samples (x-axis) and from the Qiagen DNeasy extracted samples (y-axis) colored by species identity. The left panel shows the relationship between the two extraction procedures before correction with metacal. The right panel shows the relationship after correction. The dashed line is 1:1. \n:::\n\n\n## Calibrate\n\nMake a matrix of observed counts\n\n::: {.cell}\n\n```{.r .cell-code}\ntrios_2_cal <- left_join(samp_trios, mddf) %>% \n  dplyr::select(sample, strainID, count_correct) %>% \n  pivot_wider(names_from=\"strainID\", values_from=\"count_correct\") %>% \n  column_to_rownames(var=\"sample\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>%\n  as.matrix()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nJoining with `by = join_by(sample, replicate, strep_conc, transfers, n_species,\ncommunity_type, plate_well)`\n```\n\n\n:::\n\n```{.r .cell-code}\npairs_2_cal <- left_join(samp_pairs, mddf) %>% \n  dplyr::select(sample, strainID, count_correct) %>% \n  pivot_wider(names_from=\"strainID\", values_from=\"count_correct\") %>% \n  column_to_rownames(var=\"sample\") %>% \n  mutate(across(everything(), ~replace_na(.x, 0))) %>%\n  as.matrix()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nJoining with `by = join_by(sample, replicate, strep_conc, transfers, n_species,\ncommunity_type, plate_well)`\n```\n\n\n:::\n:::\n\n\n## Run the calibrate function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(435761)\n\npairs_calibrated <- metacal::calibrate(pairs_2_cal, coef(mc_fit_trios), margin=1)\ntrios_calibrated <- metacal::calibrate(trios_2_cal, coef(mc_fit_trios), margin=1)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npairs_calibrated_l <- data.frame(pairs_calibrated) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample, names_to = \"strainID\", values_to = \"f_metacal\") %>% \n  filter(f_metacal > 0)\n\ntrios_calibrated_l <- data.frame(trios_calibrated) %>% \n  rownames_to_column(var = \"sample\") %>% \n  pivot_longer(-sample, names_to = \"strainID\", values_to = \"f_metacal\") %>% \n  filter(f_metacal > 0)\n```\n:::\n\n\n# Export\n\nSave metacal esimates for later use\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_tsv(pairs_calibrated_l, here::here(data, \"pairs_metacal.tsv\"))\nwrite_tsv(trios_calibrated_l, here::here(data, \"trios_metacal.tsv\"))\n```\n:::\n",
    "supporting": [
      "02_correct_boil_to_qiagen_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}