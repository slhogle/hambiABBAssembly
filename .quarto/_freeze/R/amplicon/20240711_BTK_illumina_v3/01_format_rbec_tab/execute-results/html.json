{
  "hash": "277d9f4a1d45d40293dc41cc48665b61",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Formatting Rbec output\"\nauthor: \"Shane Hogle\"\ndate: today\nlink-citations: true\n---\n\n\n# Introduction\n\nContains results from pairs of all streptomycin concentrations and trios for 0 streptomycin from Milla's bottom up community assembly experiment\n\n# Setup\n\n## Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\nlibrary(fs)\nlibrary(archive)\nlibrary(scales)\nsource(here::here(\"R\", \"utils_generic.R\"))\n```\n:::\n\n\n## Global variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_raw <- here::here(\"_data_raw\", \"20240711_BTK_illumina_v3\")\ndata <- here::here(\"data\", \"20240711_BTK_illumina_v3\")\namplicontar <- here::here(data_raw, \"rbec_output.tar.gz\")\n\n# make processed data directory if it doesn't exist\nfs::dir_create(data)\n\n# create temporary location to decompress\ntmpdir <- fs::file_temp()\n```\n:::\n\n\n## Data\n\nNOTE! We have commented out the species not included in this experiment  \n\n::: {.cell}\n\n```{.r .cell-code}\ntax_locus_copynum <- tibble::tribble(\n     ~strainID, ~rRNA16S_cn, ~rRNA16S_locus,             ~genus,        ~species,\n  \"HAMBI_0006\",          7L,  \"H0006_04757\",      \"Pseudomonas\",        \"putida\",\n  \"HAMBI_0097\",          7L,  \"H0097_00044\",    \"Acinetobacter\",     \"johnsonii\",\n  \"HAMBI_0097\",          7L,  \"H0097_02759\",    \"Acinetobacter\",     \"johnsonii\",\n  \"HAMBI_0097\",          7L,  \"H0097_01762\",    \"Acinetobacter\",     \"johnsonii\",\n  \"HAMBI_0105\",          4L,  \"H0105_02306\",    \"Agrobacterium\",   \"tumefaciens\",\n  \"HAMBI_0262\",          3L,  \"H0262_00030\",    \"Brevundimonas\",       \"bullata\",\n  \"HAMBI_0403\",          9L,  \"H0403_00517\",        \"Comamonas\",  \"testosteroni\",\n  \"HAMBI_0403\",          9L,  \"H0403_00522\",        \"Comamonas\",  \"testosteroni\",\n  \"HAMBI_1279\",          7L,  \"H1279_03627\",           \"Hafnia\",         \"alvei\",\n  \"HAMBI_1279\",          7L,  \"H1279_00125\",           \"Hafnia\",         \"alvei\",\n  \"HAMBI_1279\",          7L,  \"H1279_03957\",           \"Hafnia\",         \"alvei\",\n  \"HAMBI_1287\",          7L,  \"H1287_03997\",      \"Citrobacter\",        \"koseri\",\n  \"HAMBI_1287\",          7L,  \"H1287_03402\",      \"Citrobacter\",        \"koseri\",\n  \"HAMBI_1292\",          7L,  \"H1292_03239\",       \"Morganella\",      \"morganii\",\n  \"HAMBI_1299\",          8L,  \"H1299_04293\",         \"Kluyvera\",    \"intermedia\",\n  \"HAMBI_1299\",          8L,  \"H1299_01283\",         \"Kluyvera\",    \"intermedia\",\n  \"HAMBI_1299\",          8L,  \"H1279_03957\",         \"Kluyvera\",    \"intermedia\",\n  \"HAMBI_1842\",          4L,  \"H1842_01650\",      \"Sphingobium\",    \"yanoikuyae\",\n  \"HAMBI_1896\",          4L,  \"H1896_00963\", \"Sphingobacterium\",  \"spiritivorum\",\n  \"HAMBI_1972\",         10L,  \"H1972_00343\",        \"Aeromonas\",        \"caviae\",\n  \"HAMBI_1972\",         10L,  \"H1972_03531\",        \"Aeromonas\",        \"caviae\",\n  \"HAMBI_1977\",          5L,  \"H1977_00118\",      \"Pseudomonas\",  \"chlororaphis\",\n  \"HAMBI_1988\",          5L,  \"H1988_05160\",     \"Chitinophaga\",        \"sancti\",\n  \"HAMBI_1988\",          5L,  \"H1988_05152\",     \"Chitinophaga\",        \"sancti\",\n  \"HAMBI_1988\",          5L,  \"H1988_05165\",     \"Chitinophaga\",        \"sancti\",\n  \"HAMBI_2159\",          4L,  \"H2159_01406\",        \"Trinickia\",   \"caryophylli\",\n  \"HAMBI_2159\",          4L,  \"H2159_05851\",        \"Trinickia\",   \"caryophylli\",\n  \"HAMBI_2160\",          3L,  \"H2160_00530\",       \"Bordetella\",         \"avium\",\n  \"HAMBI_2164\",          5L,  \"H2164_03337\",      \"Cupriavidus\",    \"oxalaticus\",\n  \"HAMBI_2443\",          3L,  \"H2443_00128\",       \"Paracoccus\", \"denitrificans\",\n  \"HAMBI_2494\",          4L,  \"H2494_03389\", \"Paraburkholderia\",   \"kururiensis\",\n  \"HAMBI_2659\",          4L,  \"H2659_00367\", \"Stenotrophomonas\",   \"maltophilia\",\n  \"HAMBI_2792\",          4L,  \"H2792_00549\",        \"Moraxella\",         \"canis\",\n  \"HAMBI_3031\",          2L,  \"H3031_00830\",         \"Niabella\",  \"yanshanensis\",\n  \"HAMBI_3237\",          6L,  \"H3237_00875\",       \"Microvirga\",   \"lotononidis\",\n  \"HAMBI_1923\",          6L,  \"H1923_00876\",   \"Flavobacterium\",      \"odoratum\"\n  )\n```\n:::\n\n\n## Functions\n\n::: {.cell}\n\n```{.r .cell-code}\n# this function \nnormalize_by_copy <- function(.data, tlc = tax_locus_copynum){\n  .data %>% \n    # join with the copy number data frame. We join by the locus tag so this will add H1279_03957 to HAMBI_1299\n    dplyr::left_join(tlc, by = join_by(rRNA16S_locus)) %>%\n    # get total number of mapping reads per species. This aggregates all the difference ASVs per species\n    dplyr::summarize(count = sum(count), .by = c(sample, strainID, rRNA16S_cn)) %>% \n    # group by sample\n    dplyr::group_by(sample) %>% \n    # calculate a corrected count which is simply the count divided by copy num for each species\n    # dividide by the sum of count divided by copy num for whole sample multiplied by the total\n    # number of mapped reads per sample\n    dplyr::mutate(count_correct = round(sum(count)*(count/rRNA16S_cn)/sum(count/rRNA16S_cn))) %>%  \n    dplyr::ungroup() %>% \n    dplyr::select(sample, strainID, count, count_correct)\n  }\n\n# this function replaces missing species counts with zero\ncompletecombos <- function(.data, tlc = tax_locus_copynum, countname = count, remove1923 = TRUE){\n \n  # get unique strainIDs\n  strainID <- unique(tlc$strainID)\n  # table for assigning genus and species names. Doesn't matter if 1923 is there or not\n  # because it is filter joined later\n  tax <- dplyr::distinct(dplyr::select(tlc, strainID, genus, species))\n  if (remove1923) {\n    # get unique strainIDs but exclude 1923 if remove1923 is true\n    strainID <- strainID[strainID != \"HAMBI_1923\"]\n  }\n  \n  dplyr::bind_rows(tibble::tibble(strainID = strainID, sample = \"dummy\"), .data) %>% \n    dplyr::mutate( \"{{ countname }}\" := dplyr::if_else(sample == \"dummy\", 1, {{ countname }})) %>% \n    tidyr::complete(sample, strainID) %>% \n    dplyr::filter(sample != \"dummy\") %>% \n    dplyr::mutate( \"{{ countname }}\" := dplyr::if_else(is.na({{ countname }}), 0, {{ countname }})) %>% \n    tidyr::replace_na(list(count_correct = 0)) %>% \n    dplyr::left_join(dplyr::distinct(dplyr::select(tlc, strainID, genus, species))) %>% \n    dplyr::relocate(genus, species, .after = strainID)\n}\n```\n:::\n\n\n# Read metadata\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmddf <- readr::read_tsv(here::here(data_raw, \"20240711_BTK_illumina_v3_metadata.tsv\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 736 Columns: 9\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \"\\t\"\nchr (5): sample, community_id, community_type, plate_well, notes\ndbl (4): n_species, transfers, strep_conc, replicate\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n\n```{.r .cell-code}\nspdf <- readr::read_tsv(here::here(data_raw, \"sample_compositions.tsv\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 384 Columns: 4\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \"\\t\"\nchr (3): community_id, evo_hist, strainID\ndbl (1): target_f\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n\n# Read Rbec raw counts tables \n\n## Untar Rbec output tarball\n\n\n::: {.cell}\n\n```{.r .cell-code}\narchive::archive_extract(\n  amplicontar,\n  dir = tmpdir,\n  files = NULL,\n  options = character(),\n  strip_components = 0L\n)\n```\n:::\n\n\n## Setup directory structure\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntabdir <- here::here(tmpdir, \"rbec_output\")\nsamppaths <- fs::dir_ls(tabdir)\nsampnames <- path_split(samppaths) %>% \n  map_chr(dplyr::last)\n```\n:::\n\n\n## Read\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstraintabs <- paste0(samppaths, \"/strain_table.txt\") %>% \n  set_names(sampnames) %>% \n  map_df(\n  read_tsv,\n  skip = 1,\n  col_names = c(\"rRNA16S_locus\",\"count\"),\n  show_col_types = FALSE, \n  .id = \"sample\") %>% \n  # naming scheme inconsistent for one sample\n  mutate(sample = if_else(sample == \"P2_s_0\", \"P02_s_0\", sample))\n```\n:::\n\n\n# Format\n\nNormalize counts by 16S copy number\n\n::: {.cell}\n\n```{.r .cell-code}\nstraintabs_norm <- normalize_by_copy(straintabs)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in dplyr::left_join(., tlc, by = join_by(rRNA16S_locus)): Detected an unexpected many-to-many relationship between `x` and `y`.\nℹ Row 1826 of `x` matches multiple rows in `y`.\nℹ Row 19 of `y` matches multiple rows in `x`.\nℹ If a many-to-many relationship is expected, set `relationship =\n  \"many-to-many\"` to silence this warning.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinaltable <- left_join(straintabs_norm, mddf) %>% \n  left_join(spdf)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nJoining with `by = join_by(sample)`\nJoining with `by = join_by(strainID, community_id)`\n```\n\n\n:::\n:::\n\n\n# Analysis\n\n## Negative controls\n\nFirst, we'll check whether the experimental and plate negative controls look good\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinaltable %>% \n  filter(str_detect(community_type, \"^neg|pos\")) %>% \n  summarize(tot = sum(count_correct), .by = c(\"sample\", \"community_id\", \"n_species\", \"community_type\", \"replicate\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"sample\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"community_id\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"n_species\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"community_type\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"replicate\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"tot\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"3sp_1_0\",\"2\":\"T01\",\"3\":\"3\",\"4\":\"pos_ctrl\",\"5\":\"1\",\"6\":\"12125\"},{\"1\":\"3sp_2_0\",\"2\":\"T03\",\"3\":\"3\",\"4\":\"pos_ctrl\",\"5\":\"2\",\"6\":\"12316\"},{\"1\":\"3sp_3_0\",\"2\":\"T25\",\"3\":\"3\",\"4\":\"pos_ctrl\",\"5\":\"3\",\"6\":\"12949\"},{\"1\":\"3sp_4_0\",\"2\":\"T27\",\"3\":\"3\",\"4\":\"pos_ctrl\",\"5\":\"4\",\"6\":\"8938\"},{\"1\":\"3sp_5_0\",\"2\":\"T50\",\"3\":\"3\",\"4\":\"pos_ctrl\",\"5\":\"5\",\"6\":\"11061\"},{\"1\":\"3sp_6_0\",\"2\":\"T51\",\"3\":\"3\",\"4\":\"pos_ctrl\",\"5\":\"6\",\"6\":\"8641\"},{\"1\":\"3sp_7_0\",\"2\":\"T73\",\"3\":\"3\",\"4\":\"pos_ctrl\",\"5\":\"7\",\"6\":\"13812\"},{\"1\":\"3sp_8_0\",\"2\":\"T74\",\"3\":\"3\",\"4\":\"pos_ctrl\",\"5\":\"8\",\"6\":\"13828\"},{\"1\":\"neg_1_0\",\"2\":\"pairs_0_1_G02\",\"3\":\"0\",\"4\":\"neg_ctrl\",\"5\":\"1\",\"6\":\"116\"},{\"1\":\"neg_2_0\",\"2\":\"pairs_0_1_D05\",\"3\":\"0\",\"4\":\"neg_ctrl\",\"5\":\"2\",\"6\":\"9018\"},{\"1\":\"neg_3_0\",\"2\":\"pairs_0_1_G08\",\"3\":\"0\",\"4\":\"neg_ctrl\",\"5\":\"3\",\"6\":\"9213\"},{\"1\":\"neg_4_0\",\"2\":\"pairs_0_1_C12\",\"3\":\"0\",\"4\":\"neg_ctrl\",\"5\":\"4\",\"6\":\"8767\"},{\"1\":\"neg_5_0\",\"2\":\"pairs_0_1_B01\",\"3\":\"0\",\"4\":\"neg_ctrl\",\"5\":\"5\",\"6\":\"98\"},{\"1\":\"neg_6_0\",\"2\":\"pairs_0_1_E04\",\"3\":\"0\",\"4\":\"neg_ctrl\",\"5\":\"6\",\"6\":\"73\"},{\"1\":\"neg_7_0\",\"2\":\"pairs_0_1_H07\",\"3\":\"0\",\"4\":\"neg_ctrl\",\"5\":\"7\",\"6\":\"106\"},{\"1\":\"neg_8_0\",\"2\":\"pairs_0_1_E10\",\"3\":\"0\",\"4\":\"neg_ctrl\",\"5\":\"8\",\"6\":\"189\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nThis looks ok, but there are potentially some problems. Specifically, negative control replicates 2, 3, and 4 all have some contamination. `neg_2_0` seems to be contaminated with HAMBI_1977, `neg_3_0` with HAMBI_1287, and `neg_4_0` with HAMBI_1977. However in the 5 remaining negative controls there is no contamination.\n\n## Positive controls\n\nThe positive controls should each have three species. In all cases the species that shouldn't be there is very rare\n\n::: {.cell}\n\n```{.r .cell-code}\nfinaltable %>% \n  filter(str_detect(community_type, \"^pos\")) %>%\n  mutate(total_pos_controls = n_distinct(sample)) %>% \n  group_by(sample) %>% \n  mutate(f = round(count_correct/sum(count_correct)*100)) %>%\n  mutate(supposed_2_b_there = if_else(is.na(evo_hist), \"no\", \"yes\")) %>% \n  relocate(f, supposed_2_b_there) %>% \n  distinct(f, supposed_2_b_there, sample, strainID, count_correct, n_species, community_type,)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"f\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"supposed_2_b_there\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"sample\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"strainID\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"count_correct\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"n_species\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"community_type\"],\"name\":[7],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"89\",\"2\":\"yes\",\"3\":\"3sp_1_0\",\"4\":\"HAMBI_0403\",\"5\":\"10766\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"6\",\"2\":\"yes\",\"3\":\"3sp_1_0\",\"4\":\"HAMBI_1287\",\"5\":\"698\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"5\",\"2\":\"yes\",\"3\":\"3sp_1_0\",\"4\":\"HAMBI_1896\",\"5\":\"620\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"0\",\"2\":\"no\",\"3\":\"3sp_1_0\",\"4\":\"HAMBI_1977\",\"5\":\"41\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"62\",\"2\":\"yes\",\"3\":\"3sp_2_0\",\"4\":\"HAMBI_1896\",\"5\":\"7667\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"28\",\"2\":\"yes\",\"3\":\"3sp_2_0\",\"4\":\"HAMBI_0403\",\"5\":\"3406\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"10\",\"2\":\"yes\",\"3\":\"3sp_2_0\",\"4\":\"HAMBI_1287\",\"5\":\"1206\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"0\",\"2\":\"no\",\"3\":\"3sp_2_0\",\"4\":\"HAMBI_1977\",\"5\":\"37\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"91\",\"2\":\"yes\",\"3\":\"3sp_3_0\",\"4\":\"HAMBI_0403\",\"5\":\"11796\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"6\",\"2\":\"yes\",\"3\":\"3sp_3_0\",\"4\":\"HAMBI_1287\",\"5\":\"738\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"3\",\"2\":\"yes\",\"3\":\"3sp_3_0\",\"4\":\"HAMBI_1977\",\"5\":\"373\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"0\",\"2\":\"no\",\"3\":\"3sp_3_0\",\"4\":\"HAMBI_1896\",\"5\":\"42\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"74\",\"2\":\"yes\",\"3\":\"3sp_4_0\",\"4\":\"HAMBI_1977\",\"5\":\"6618\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"16\",\"2\":\"yes\",\"3\":\"3sp_4_0\",\"4\":\"HAMBI_1287\",\"5\":\"1435\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"9\",\"2\":\"yes\",\"3\":\"3sp_4_0\",\"4\":\"HAMBI_0403\",\"5\":\"834\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"1\",\"2\":\"no\",\"3\":\"3sp_4_0\",\"4\":\"HAMBI_1896\",\"5\":\"51\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"69\",\"2\":\"yes\",\"3\":\"3sp_5_0\",\"4\":\"HAMBI_1896\",\"5\":\"7661\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"24\",\"2\":\"yes\",\"3\":\"3sp_5_0\",\"4\":\"HAMBI_0403\",\"5\":\"2643\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"7\",\"2\":\"yes\",\"3\":\"3sp_5_0\",\"4\":\"HAMBI_1977\",\"5\":\"751\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"0\",\"2\":\"no\",\"3\":\"3sp_5_0\",\"4\":\"HAMBI_1287\",\"5\":\"6\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"53\",\"2\":\"yes\",\"3\":\"3sp_6_0\",\"4\":\"HAMBI_1977\",\"5\":\"4593\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"34\",\"2\":\"yes\",\"3\":\"3sp_6_0\",\"4\":\"HAMBI_0403\",\"5\":\"2927\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"13\",\"2\":\"yes\",\"3\":\"3sp_6_0\",\"4\":\"HAMBI_1896\",\"5\":\"1113\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"0\",\"2\":\"no\",\"3\":\"3sp_6_0\",\"4\":\"HAMBI_1287\",\"5\":\"8\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"76\",\"2\":\"yes\",\"3\":\"3sp_7_0\",\"4\":\"HAMBI_1287\",\"5\":\"10482\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"16\",\"2\":\"yes\",\"3\":\"3sp_7_0\",\"4\":\"HAMBI_1896\",\"5\":\"2278\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"7\",\"2\":\"yes\",\"3\":\"3sp_7_0\",\"4\":\"HAMBI_1977\",\"5\":\"1019\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"0\",\"2\":\"no\",\"3\":\"3sp_7_0\",\"4\":\"HAMBI_0403\",\"5\":\"33\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"82\",\"2\":\"yes\",\"3\":\"3sp_8_0\",\"4\":\"HAMBI_1896\",\"5\":\"11396\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"12\",\"2\":\"yes\",\"3\":\"3sp_8_0\",\"4\":\"HAMBI_1287\",\"5\":\"1638\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"6\",\"2\":\"yes\",\"3\":\"3sp_8_0\",\"4\":\"HAMBI_1977\",\"5\":\"763\",\"6\":\"3\",\"7\":\"pos_ctrl\"},{\"1\":\"0\",\"2\":\"no\",\"3\":\"3sp_8_0\",\"4\":\"HAMBI_0403\",\"5\":\"31\",\"6\":\"3\",\"7\":\"pos_ctrl\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\nThis is also good - we detect all 3 species that should be there in the positive controls on each plate. In a later step we will use these control samples with `metacal` to try and correct for the boil prep extraction method. \n\n## Misassigned reads\n\nThese libraries were only prepared with samples from Milla's 4-species experiment with 403, 1287, 1896, and 1977 so any time species other than these show up is just an incorrect assignment by Rbec. Let's check quickly how many of these there are...\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinaltable %>% \n  filter(!str_detect(strainID, \"0403|1287|1896|1977\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"sample\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"strainID\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"count\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"count_correct\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"community_id\"],\"name\":[5],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"n_species\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"community_type\"],\"name\":[7],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"transfers\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"strep_conc\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"replicate\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"plate_well\"],\"name\":[11],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"notes\"],\"name\":[12],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"evo_hist\"],\"name\":[13],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"target_f\"],\"name\":[14],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"P02_1_256\",\"2\":\"HAMBI_1972\",\"3\":\"1\",\"4\":\"0\",\"5\":\"P02\",\"6\":\"2\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"256\",\"10\":\"1\",\"11\":\"02B\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P22_s_0\",\"2\":\"HAMBI_0006\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P22\",\"6\":\"2\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"02E\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P25_2_256\",\"2\":\"HAMBI_2659\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P25\",\"6\":\"2\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"256\",\"10\":\"2\",\"11\":\"02C\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P26_2_0\",\"2\":\"HAMBI_1972\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P26\",\"6\":\"2\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"0\",\"10\":\"2\",\"11\":\"01D\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P27_s_0\",\"2\":\"HAMBI_2659\",\"3\":\"2\",\"4\":\"2\",\"5\":\"P27\",\"6\":\"2\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"06A\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P27_s_0\",\"2\":\"HAMBI_0006\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P27\",\"6\":\"2\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"06A\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P32_1_0\",\"2\":\"HAMBI_2659\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P32\",\"6\":\"2\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"0\",\"10\":\"1\",\"11\":\"04D\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P35_2_256\",\"2\":\"HAMBI_1279\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P35\",\"6\":\"2\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"256\",\"10\":\"2\",\"11\":\"12G\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P35_2_256\",\"2\":\"HAMBI_1299\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P35\",\"6\":\"2\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"256\",\"10\":\"2\",\"11\":\"12G\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P36_1_0\",\"2\":\"HAMBI_1972\",\"3\":\"2\",\"4\":\"1\",\"5\":\"P36\",\"6\":\"2\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"0\",\"10\":\"1\",\"11\":\"12H\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P36_s_0\",\"2\":\"HAMBI_2659\",\"3\":\"1\",\"4\":\"2\",\"5\":\"P36\",\"6\":\"2\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"05H\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P42_s_0\",\"2\":\"HAMBI_2659\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P42\",\"6\":\"2\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"05D\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P43_s_0\",\"2\":\"HAMBI_0006\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P43\",\"6\":\"2\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"06D\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P46_s_0\",\"2\":\"HAMBI_0006\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P46\",\"6\":\"2\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"05E\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"P47_2_64\",\"2\":\"HAMBI_0006\",\"3\":\"1\",\"4\":\"1\",\"5\":\"P47\",\"6\":\"2\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"64\",\"10\":\"2\",\"11\":\"12C\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"T01_s_0\",\"2\":\"HAMBI_1972\",\"3\":\"1\",\"4\":\"1\",\"5\":\"T01\",\"6\":\"3\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"01E\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"T18_1_0\",\"2\":\"HAMBI_1972\",\"3\":\"1\",\"4\":\"1\",\"5\":\"T18\",\"6\":\"3\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"0\",\"10\":\"1\",\"11\":\"02B\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"T23_s_0\",\"2\":\"HAMBI_1972\",\"3\":\"5\",\"4\":\"3\",\"5\":\"T23\",\"6\":\"3\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"06D\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"T25_1_0\",\"2\":\"HAMBI_1972\",\"3\":\"1\",\"4\":\"1\",\"5\":\"T25\",\"6\":\"3\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"0\",\"10\":\"1\",\"11\":\"03E\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"T28_2_0\",\"2\":\"HAMBI_3031\",\"3\":\"1\",\"4\":\"3\",\"5\":\"T28\",\"6\":\"3\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"0\",\"10\":\"2\",\"11\":\"03F\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"T35_s_0\",\"2\":\"HAMBI_1972\",\"3\":\"1\",\"4\":\"1\",\"5\":\"T35\",\"6\":\"3\",\"7\":\"masterplate\",\"8\":\"0\",\"9\":\"NA\",\"10\":\"1\",\"11\":\"07D\",\"12\":\"Masterplate samples are those that were constructed ahead of time, then thawed and used in the experiment. They had no time to grow and thus should contain only what we put into them in roughly the proportions we intended\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"T56_1_0\",\"2\":\"HAMBI_0006\",\"3\":\"1\",\"4\":\"1\",\"5\":\"T56\",\"6\":\"3\",\"7\":\"experiment\",\"8\":\"8\",\"9\":\"0\",\"10\":\"1\",\"11\":\"11C\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"neg_5_0\",\"2\":\"HAMBI_1972\",\"3\":\"1\",\"4\":\"1\",\"5\":\"pairs_0_1_B01\",\"6\":\"0\",\"7\":\"neg_ctrl\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"5\",\"11\":\"08E\",\"12\":\"These samples were extracted from blank wells on the pairs plate. Goal was to use this to check for contamination during the experiment\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"neg_7_0\",\"2\":\"HAMBI_1972\",\"3\":\"3\",\"4\":\"2\",\"5\":\"pairs_0_1_H07\",\"6\":\"0\",\"7\":\"neg_ctrl\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"7\",\"11\":\"08G\",\"12\":\"These samples were extracted from blank wells on the pairs plate. Goal was to use this to check for contamination during the experiment\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"neg_7_0\",\"2\":\"HAMBI_1292\",\"3\":\"1\",\"4\":\"1\",\"5\":\"pairs_0_1_H07\",\"6\":\"0\",\"7\":\"neg_ctrl\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"7\",\"11\":\"08G\",\"12\":\"These samples were extracted from blank wells on the pairs plate. Goal was to use this to check for contamination during the experiment\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"neg_8_0\",\"2\":\"HAMBI_1972\",\"3\":\"29\",\"4\":\"19\",\"5\":\"pairs_0_1_E10\",\"6\":\"0\",\"7\":\"neg_ctrl\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"8\",\"11\":\"08H\",\"12\":\"These samples were extracted from blank wells on the pairs plate. Goal was to use this to check for contamination during the experiment\",\"13\":\"NA\",\"14\":\"NA\"},{\"1\":\"neg_8_0\",\"2\":\"HAMBI_0105\",\"3\":\"1\",\"4\":\"2\",\"5\":\"pairs_0_1_E10\",\"6\":\"0\",\"7\":\"neg_ctrl\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"8\",\"11\":\"08H\",\"12\":\"These samples were extracted from blank wells on the pairs plate. Goal was to use this to check for contamination during the experiment\",\"13\":\"NA\",\"14\":\"NA\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nThere is one or two incorrectly assigned reads here and there but this is just noise. We can safely exclude all reads not mapping to one of the focal species.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinaltable <- finaltable %>% \n  filter(str_detect(strainID, \"0403|1287|1896|1977\"))\n```\n:::\n\n\n## Samples with too few reads\n\nSome of the experimental pairs had streptomycin concentrations higher than any of the species individually could tolerate. We would naively expect then that neither species would grow successfully in these samples and that the overall biomass would be very low, thus resulting in a low number of recovered reads from these samples.\n\nTo look into this. first let's check which samples have very low OD600 in the endpoint samples.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nod <- read_tsv(here::here(\"_data_raw\", \"20240606_optical_density\", \"optical_density_formatted.tsv\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 2880 Columns: 6\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \"\\t\"\nchr (1): community_id\ndbl (5): transfers, n_species, strep_conc, replicate, OD\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfiltids <- finaltable %>% \n  summarize(tot = sum(count_correct), .by = c(sample, community_id, n_species, transfers, strep_conc, replicate)) %>%\n  left_join(od, by = join_by(community_id, n_species, transfers, strep_conc, replicate)) %>% \n  filter(transfers == 8) %>% \n  arrange(tot) %>% \n  arrange(OD) %>% \n  filter(OD < 0.1 | tot < 1000) %>% \n  pull(sample)\n```\n:::\n\n\nWe'll filter out samples with an OD of less than 0.1 and also samples with fewer than 1000 reads. It is genearlly good practice to exclude samples with low number of reads.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinaltable <- finaltable %>% \n  filter(sample %nin% filtids)\n```\n:::\n\n\n## Masterplate samples\n\nTo set up this experiment, Milla combined the species in the planned proportions on a masterplate. Because this process was time consuming, the masterplate was stored at -80C after construction until the experiment start day when it was taken from the freezer and used to inoculate the experiment. Because Milla knows exactly which strains were added to the master plate and the plates were not allowed to grow, any strains in these samples that are not supposed to be there should be due to Illumina index cross talk and not true contamination. We can get a sense for the average index crosstalk rate from these samples and then draw a threshold of when to exclude likely false positives and when a positive is likely due to contamination.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmasterplate <- finaltable %>%\n  filter(community_type == \"masterplate\") %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup()\n```\n:::\n\n\nHere we focus on masterplate samples with species that should not be there. We exclude species that were inoculated and plot the distribution of percentages of those species\n\n::: {#fig-01}\n\n::: {.cell}\n\n```{.r .cell-code}\nmasterplate %>% \n  # here we take advantage of the fact that for species not supposed to be in a sample\n  # the prior left_join will have filled the evo_hist category with an NA. We can then filter\n  # on this NA value\n  filter(is.na(evo_hist)) %>% \n  filter(f > 0) %>% \n  ggplot(aes(x = f)) +\n  geom_histogram(aes(fill = strainID), bins = 20) +\n  geom_vline(xintercept = 0.01, linetype = \"dashed\") +\n  scale_fill_manual(values = hambi_colors) +\n  scale_x_continuous(trans = \"log10\",  labels = percent, guide = guide_axis(angle=90)) + \n  labs(x = \"Crosstalk frequency\", y = \"Count\") +\n  facet_grid(~strainID) + \n  annotation_logticks(sides = \"b\", color=\"grey30\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](01_format_rbec_tab_files/figure-html/unnamed-chunk-19-1.png){width=768}\n:::\n:::\n\n\nFrequency distribution of each species in masterplate samples where it **should not** occur. The 1% mark (commonly accepted as an acceptable Illumina cross-talk standard) is demarcated with a dashed line. \n:::\n\nGenerally, the cross talk frequency is pretty OK. For 3/4 species it is 1% or less which is more or less what you can expect when you are multiplexing libraries on an Illumina platform. Values greater than 1% are potentially indicative of a different problem, so 1977 requires a bit more investigation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsids <- masterplate %>% \n  filter(is.na(evo_hist)) %>% \n  filter(f > 0.01 & strainID == \"HAMBI_1977\") %>% \n  pull(sample) \n\nmasterplate %>% \n  filter(sample %in% sids) %>% \n  dplyr::select(sample, strainID, count_correct, replicate, evo_hist, target_f, f)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"sample\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"strainID\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"count_correct\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"replicate\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"evo_hist\"],\"name\":[5],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"target_f\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"f\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"P19_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"3135\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.9\",\"7\":\"0.847984853\"},{\"1\":\"P19_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"481\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.130105491\"},{\"1\":\"P19_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"58\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.015688396\"},{\"1\":\"P19_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"23\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.006221260\"},{\"1\":\"P20_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"3335\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.9\",\"7\":\"0.842171717\"},{\"1\":\"P20_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"541\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.1\",\"7\":\"0.136616162\"},{\"1\":\"P20_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"50\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.012626263\"},{\"1\":\"P20_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"34\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.008585859\"},{\"1\":\"P30_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"4458\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.9\",\"7\":\"0.834518907\"},{\"1\":\"P30_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"721\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.134968177\"},{\"1\":\"P30_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"102\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.019093972\"},{\"1\":\"P30_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"61\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.011418944\"},{\"1\":\"P36_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"3969\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.9\",\"7\":\"0.686440678\"},{\"1\":\"P36_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"1519\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.1\",\"7\":\"0.262711864\"},{\"1\":\"P36_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"209\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.036146662\"},{\"1\":\"P36_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"85\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.014700796\"},{\"1\":\"T08_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"4684\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.8\",\"7\":\"0.626538256\"},{\"1\":\"T08_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"1273\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.170278224\"},{\"1\":\"T08_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"1421\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.190074906\"},{\"1\":\"T08_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"98\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.013108614\"},{\"1\":\"T11_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"2851\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.502201867\"},{\"1\":\"T11_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"1313\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.8\",\"7\":\"0.231284129\"},{\"1\":\"T11_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"1368\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.1\",\"7\":\"0.240972345\"},{\"1\":\"T11_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"145\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.025541659\"},{\"1\":\"T15_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"6373\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.8\",\"7\":\"0.775209828\"},{\"1\":\"T15_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"1011\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.122977740\"},{\"1\":\"T15_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"663\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.080647123\"},{\"1\":\"T15_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"174\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.021165308\"},{\"1\":\"T18_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"5204\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.8\",\"7\":\"0.844120032\"},{\"1\":\"T18_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"705\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.1\",\"7\":\"0.114355231\"},{\"1\":\"T18_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"163\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.026439578\"},{\"1\":\"T18_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"93\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.015085158\"},{\"1\":\"T20_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"3454\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.8\",\"7\":\"0.469995918\"},{\"1\":\"T20_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"1436\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.195400735\"},{\"1\":\"T20_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"2342\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.1\",\"7\":\"0.318682814\"},{\"1\":\"T20_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"117\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.015920533\"},{\"1\":\"T21_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"6811\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.8\",\"7\":\"0.776890613\"},{\"1\":\"T21_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"1039\",\"4\":\"1\",\"5\":\"anc\",\"6\":\"0.1\",\"7\":\"0.118512604\"},{\"1\":\"T21_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"773\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.1\",\"7\":\"0.088171552\"},{\"1\":\"T21_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"144\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.016425231\"},{\"1\":\"T24_s_0\",\"2\":\"HAMBI_1896\",\"3\":\"4335\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.8\",\"7\":\"0.784615385\"},{\"1\":\"T24_s_0\",\"2\":\"HAMBI_1287\",\"3\":\"578\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.1\",\"7\":\"0.104615385\"},{\"1\":\"T24_s_0\",\"2\":\"HAMBI_0403\",\"3\":\"529\",\"4\":\"1\",\"5\":\"evo\",\"6\":\"0.1\",\"7\":\"0.095746606\"},{\"1\":\"T24_s_0\",\"2\":\"HAMBI_1977\",\"3\":\"83\",\"4\":\"1\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"0.015022624\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nIt looks like all the \"problematic\" samples come from plates 7 and 8 in the library prep. Plate 8 only contains the masterplate samples from trios whereas plate 7 contains both masterplate and experimental samples. @Fig-02 shows that HAMBI-1977 is very abundant in many of the samples so likely the \"leaky\" reads come disproportionately from HAMBI-1977 which is why its crosstalk threshold may be higher (@Fig-01). \n\n::: {#fig-02}\n\n::: {.cell}\n\n```{.r .cell-code}\nfinaltable %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # here we take advantage of the fact that for species not supposed to be in a sample\n  # the prior left_join will have filled the evo_hist category with an NA. We can then filter\n  # on this NA value\n  filter(!is.na(evo_hist)) %>% \n  filter(f > 0) %>% \n  ggplot(aes(x = f)) +\n  geom_histogram(aes(fill = strainID), bins = 20) +\n  scale_fill_manual(values = hambi_colors) +\n  scale_x_continuous(trans = \"log10\",  labels = percent, guide = guide_axis(angle=90)) + \n  labs(x = \"Frequency in samples\", y = \"Count\") +\n  facet_grid(~strainID) + \n  annotation_logticks(sides = \"b\", color=\"grey30\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](01_format_rbec_tab_files/figure-html/unnamed-chunk-21-1.png){width=768}\n:::\n:::\n\nFrequency distribution of each species in all samples where it **should** occur.\n:::\n\nAnyway, I don't think this is a problem and that we can move forward with these samples. However, to define extinction/competitive exclusion we may need to use a higher threshold than 1% (e.g., 3% frequency) because over 3% we can reliably say that a species is present and it is not due to index cross talk.\n\n## Experimental samples\n\nNow we need to see how our experimental samples performed and if there are species present in them that shouldn't be there\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_contam <- finaltable %>% \n  filter(str_detect(community_type, \"experiment\")) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # because we set 3% as our limit of detection we set read counts of species \n  # less than 1% to 0\n  mutate(count_correct_thresh = if_else(f <= 0.03, 0, count_correct)) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct_thresh/sum(count_correct_thresh)) %>% \n  ungroup()\n```\n:::\n\n\n\n::: {#fig-03}\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_contam %>% \n  filter(is.na(evo_hist)) %>% \n  ggplot(aes(x = f)) +\n  geom_histogram(aes(fill = strainID), bins = 20) +\n  scale_fill_manual(values = hambi_colors) +\n  scale_x_continuous(trans = \"log10\",  labels = percent, guide = guide_axis(angle=90)) + \n  labs(x = \"Frequency in samples\", y = \"Count\") +\n  facet_grid(~ strainID) + \n  annotation_logticks(sides = \"b\", color=\"grey30\") +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"bottom\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in scale_x_continuous(trans = \"log10\", labels = percent, guide =\nguide_axis(angle = 90)): log-10 transformation introduced infinite values.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 783 rows containing non-finite outside the scale range\n(`stat_bin()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](01_format_rbec_tab_files/figure-html/unnamed-chunk-23-1.png){width=768}\n:::\n:::\n\nFrequency distribution of each species in experimental samples where it **should not** occcur.\n:::\n\n\n::: {.cell}\n\n:::\n\n\nIt's not too bad... but 72 of 566 samples (12.7%) have probably been contaminated because they contain a species that shouldn't be in the sample (using the 3% relative abundance as a robust threshold for presence/absence).\n\n### Contaminated pairs\n\nTaking a closer look at specific experimental samples with contamination.\n\nHere we just select samples that have > 3% of a species that shouldn't be there and prepare them for plotting.\n\n::: {.cell}\n\n```{.r .cell-code}\ncontamsampid <- exp_contam %>% \n  filter(f > 0) %>% \n  filter(is.na(evo_hist)) %>% \n  pull(sample)\n\nspcols <- c(\"HAMBI_0403_anc\" = \"#faa019\",\n            \"HAMBI_0403_evo\" = \"#bd7811\",\n            \"HAMBI_1287_anc\" = \"#75afff\",\n            \"HAMBI_1287_evo\" = \"#476c9e\",\n            \"HAMBI_1896_anc\" = \"#59cc4e\",\n            \"HAMBI_1896_evo\" = \"#31752a\",\n            \"HAMBI_1977_anc\" = \"#ffd430\",\n            \"HAMBI_1977_evo\" = \"#ab8e1f\",\n            \n            \"HAMBI_0403_NA\"  = \"#e6e5e3\",\n            \"HAMBI_1287_NA\"  = \"#bdbcbb\",\n            \"HAMBI_1896_NA\"  = \"#8c8c8b\",\n            \"HAMBI_1977_NA\"  = \"#333333\"\n            )\n\nexp_contam_plot <- exp_contam %>%\n  filter(sample %in% contamsampid) %>% \n  mutate(sp = paste0(strainID, \"_\", evo_hist))\n```\n:::\n\n\n\n::: {#fig-04}\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_contam_plot %>% \n  filter(n_species == 2) %>% \n  ggplot() +\n  geom_col(aes(x = sample, y=f, fill = sp)) +\n  facet_wrap( ~ strep_conc, scales = \"free_x\", ncol = 2) +\n  labs(y = \"Abundance\", x = \"\", fill = \"\") +\n  scale_fill_manual(values = spcols) +\n  scale_y_continuous(labels = percent) +\n  scale_x_discrete(guide = guide_axis(angle=90)) +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![](01_format_rbec_tab_files/figure-html/unnamed-chunk-26-1.png){width=768}\n:::\n:::\n\nSpecies composition of pair samples that contain > 3% of a species that shouldn't be there (shown in grey to black).\n:::\n\nI think pretty much the only way to deal with this is to inspect manually. Most of the comtaminated samples are in the 0 Streptomycin conditions. I think we should exclude samples where the contamination is very high (over ~50% of the sample) but those with 10% or less contaminant I think can be retained, and I will discard the contaminating sequences.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnotcontampairs <- c(\"P04_1_0\", \"P45_2_0\", \"P01_2_64\", \"P03_2_64\", \n                    \"P06_1_256\", \"P17_2_256\", \"P30_1_256\", \"P30_2_256\", \n                    \"P41_2_256\")\n\ncontampairs <- setdiff(contamsampid[grepl(\"^P\", contamsampid)], notcontampairs)\n```\n:::\n\n\n\n### Contaminated trios\n\nNow we'll do the same thing and inspect the trios.\n\n::: {#fig-04}\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_contam_plot %>% \n  filter(n_species == 3) %>% \n  ggplot() +\n  geom_col(aes(x = sample, y=f, fill = sp)) +\n  labs(y = \"Abundance\", x = \"\", fill = \"\") +\n  scale_fill_manual(values = spcols) +\n  scale_y_continuous(labels = percent) +\n  scale_x_discrete(guide = guide_axis(angle=90)) +\n  theme_bw() + \n  theme(panel.grid = element_blank(),\n        legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![](01_format_rbec_tab_files/figure-html/unnamed-chunk-28-1.png){width=768}\n:::\n:::\n\nSpecies composition of trio samples that contain > 3% of a species that shouldn't be there (shown in grey to black).\n:::\n\nAgain, I think we should exclude samples where the contamination is very high (over ~50% of the sample) but those with around 10% or less contaminant I think can be retained, and I will discard the contaminating sequences.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnotcontamtrios <- c(\"T01_2_0\", \"T02_2_0\", \"T04_2_0\", \"T05_2_0\", \"T13_2_0\", \n                    \"T14_2_0\", \"T15_1_0\", \"T15_2_0\", \"T16_1_0\", \"T16_2_0\", \n                    \"T17_2_0\", \"T18_2_0\",\"T31_2_0\", \"T45_1_0\", \"T45_2_0\", \n                    \"T55_1_0\", \"T61_1_0\", \"T61_2_0\", \"T64_1_0\", \"T64_2_0\")\n\ncontamtrios <- setdiff(contamsampid[grepl(\"^T\", contamsampid)], notcontamtrios)\n```\n:::\n\n\n# Export\n\n## pos/neg control samples\n\nSeparate out the pos/neg control samples\n\n::: {.cell}\n\n```{.r .cell-code}\nfinaltable %>% \n  filter(str_detect(community_type, \"^pos|^neg\")) %>% \n  dplyr::select(-transfers, -strep_conc, -evo_hist, -target_f, -count) %>% \n  write_tsv(here::here(data, \"pos_neg_ctrl_counts.tsv\"))\n```\n:::\n\n\n## Pairs\n\nseparate, format, and write the pair samples\n\n::: {.cell}\n\n```{.r .cell-code}\npairs <- finaltable %>% \n  filter(!str_detect(community_type, \"^pos|^neg\")) %>%\n  filter(n_species == 2) %>% \n  filter(sample %nin% contampairs) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # because we set 3% as our limit of detection we set read counts of species \n  # less than 1% to 0\n  mutate(count_correct_thresh = if_else(f <= 0.03, 0, count_correct)) %>% \n  # also exclude any remaining counts from species that shouldnt be there\n  # using again the fact that evo_hist should be NA for these species\n  filter(!is.na(evo_hist)) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct_thresh/sum(count_correct_thresh)) %>% \n  ungroup() %>%\n  dplyr::select(sample, strainID, evo_hist, count_correct, count_correct_thresh, \n                f, target_f, replicate, strep_conc, transfers, n_species, community_type, plate_well)\n\nwrite_tsv(pairs, here::here(data, \"pairs_counts.tsv\"))\n```\n:::\n\n\n## Trios\n\n::: {.cell}\n\n```{.r .cell-code}\ntrios <- finaltable %>% \n  filter(!str_detect(community_type, \"^pos|^neg\")) %>%\n  filter(n_species == 3) %>% \n  filter(sample %nin% contamtrios) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct/sum(count_correct)) %>% \n  ungroup() %>% \n  # because we set 3% as our limit of detection we set read counts of species \n  # less than 1% to 0\n  mutate(count_correct_thresh = if_else(f <= 0.03, 0, count_correct)) %>% \n  # also exclude any remaining counts from species that shouldnt be there\n  # using again the fact that evo_hist should be NA for these species\n  filter(!is.na(evo_hist)) %>% \n  group_by(sample) %>% \n  mutate(f = count_correct_thresh/sum(count_correct_thresh)) %>% \n  ungroup() %>%\n  dplyr::select(sample, strainID, evo_hist, count_correct, count_correct_thresh, \n                f, target_f, replicate, strep_conc, transfers, n_species, community_type, plate_well)\n\nwrite_tsv(trios, here::here(data, \"trios_counts.tsv\"))\n```\n:::\n\n\n# Clean up\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# remove decompressed coverage directory from temp location\nfs::dir_delete(tmpdir)\n```\n:::\n",
    "supporting": [
      "01_format_rbec_tab_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}